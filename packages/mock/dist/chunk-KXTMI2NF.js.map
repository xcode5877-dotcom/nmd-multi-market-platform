{"version":3,"sources":["../src/catalog-store.ts"],"sourcesContent":["import type { Category, Product, OptionGroup, OptionItem } from '@nmd/core';\r\n\r\nconst STORAGE_KEY = 'nmd.catalog';\r\n\r\ninterface TenantCatalog {\r\n  categories: Category[];\r\n  products: Product[];\r\n  optionGroups: OptionGroup[];\r\n  optionItems: OptionItem[];\r\n}\r\n\r\nfunction load(): Record<string, TenantCatalog> {\r\n  try {\r\n    const raw = localStorage.getItem(STORAGE_KEY);\r\n    const parsed = raw ? JSON.parse(raw) : {};\r\n    for (const k of Object.keys(parsed)) {\r\n      if (!parsed[k].optionGroups) parsed[k].optionGroups = [];\r\n      if (!parsed[k].optionItems) parsed[k].optionItems = [];\r\n    }\r\n    return parsed;\r\n  } catch {\r\n    /* ignore */\r\n  }\r\n  return {};\r\n}\r\n\r\nfunction save(data: Record<string, TenantCatalog>): void {\r\n  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));\r\n}\r\n\r\nfunction normalizeCategory(c: Partial<Category>): Category {\r\n  return {\r\n    ...c,\r\n    parentId: c.parentId ?? null,\r\n    isVisible: c.isVisible ?? true,\r\n  } as Category;\r\n}\r\n\r\nexport function getCatalog(tenantId: string): TenantCatalog {\r\n  const data = load();\r\n  const cat = data[tenantId];\r\n  if (!cat) {\r\n    return { categories: [], products: [], optionGroups: [], optionItems: [] };\r\n  }\r\n  const categories = (cat.categories ?? []).map((c) => normalizeCategory(c));\r\n  return {\r\n    categories,\r\n    products: cat.products ?? [],\r\n    optionGroups: cat.optionGroups ?? [],\r\n    optionItems: cat.optionItems ?? [],\r\n  };\r\n}\r\n\r\n/** Ensure a tenant has an entry in nmd.catalog. Creates empty catalog if missing. */\r\nexport function ensureTenantCatalog(tenantId: string): TenantCatalog {\r\n  const data = load();\r\n  if (!data[tenantId]) {\r\n    const empty: TenantCatalog = {\r\n      categories: [],\r\n      products: [],\r\n      optionGroups: [],\r\n      optionItems: [],\r\n    };\r\n    data[tenantId] = empty;\r\n    save(data);\r\n    return empty;\r\n  }\r\n  const cat = data[tenantId];\r\n  const normalized: TenantCatalog = {\r\n    categories: cat.categories ?? [],\r\n    products: cat.products ?? [],\r\n    optionGroups: cat.optionGroups ?? [],\r\n    optionItems: cat.optionItems ?? [],\r\n  };\r\n  if (!cat.optionItems) {\r\n    data[tenantId] = normalized;\r\n    save(data);\r\n  }\r\n  return normalized;\r\n}\r\n\r\nexport function setCatalog(tenantId: string, catalog: TenantCatalog): void {\r\n  const data = load();\r\n  data[tenantId] = {\r\n    ...catalog,\r\n    categories: catalog.categories ?? [],\r\n    products: catalog.products ?? [],\r\n    optionGroups: catalog.optionGroups ?? [],\r\n    optionItems: catalog.optionItems ?? [],\r\n  };\r\n  save(data);\r\n}\r\n\r\nexport function listOptionGroups(tenantId: string): OptionGroup[] {\r\n  return getCatalog(tenantId).optionGroups ?? [];\r\n}\r\n\r\nexport function listOptionItemsByGroup(tenantIdOrGroupId: string, groupId?: string): OptionItem[] {\r\n  const tenantId = groupId ? tenantIdOrGroupId : undefined;\r\n  const gid = groupId ?? tenantIdOrGroupId;\r\n  if (tenantId) {\r\n    const groups = getCatalog(tenantId).optionGroups ?? [];\r\n    const g = groups.find((x) => x.id === gid);\r\n    return g?.items ?? [];\r\n  }\r\n  const tenants = Object.keys(load());\r\n  for (const tid of tenants) {\r\n    const groups = getCatalog(tid).optionGroups ?? [];\r\n    const g = groups.find((x) => x.id === gid);\r\n    if (g) return g.items ?? [];\r\n  }\r\n  return [];\r\n}\r\n\r\nexport function upsertOptionGroup(tenantId: string, group: OptionGroup): OptionGroup {\r\n  const cat = getCatalog(tenantId);\r\n  const groups = cat.optionGroups ?? [];\r\n  const idx = groups.findIndex((g) => g.id === group.id);\r\n  const withTenant = { ...group, tenantId };\r\n  if (idx >= 0) {\r\n    groups[idx] = { ...withTenant, items: groups[idx].items ?? [] };\r\n  } else {\r\n    groups.push({ ...withTenant, items: group.items ?? [] });\r\n  }\r\n  setCatalog(tenantId, { ...cat, optionGroups: groups });\r\n  return groups[idx >= 0 ? idx : groups.length - 1];\r\n}\r\n\r\nexport function deleteOptionGroup(tenantId: string, groupId: string): void {\r\n  const cat = getCatalog(tenantId);\r\n  const groups = (cat.optionGroups ?? []).filter((g) => g.id !== groupId);\r\n  setCatalog(tenantId, { ...cat, optionGroups: groups });\r\n}\r\n\r\nexport function upsertOptionItem(tenantId: string, groupId: string, item: OptionItem): OptionItem {\r\n  const cat = getCatalog(tenantId);\r\n  const groups = cat.optionGroups ?? [];\r\n  const gIdx = groups.findIndex((g) => g.id === groupId);\r\n  if (gIdx === -1) return item;\r\n  const items = groups[gIdx].items ?? [];\r\n  const iIdx = items.findIndex((i) => i.id === item.id);\r\n  const withGroup = { ...item, groupId };\r\n  if (iIdx >= 0) items[iIdx] = withGroup;\r\n  else items.push(withGroup);\r\n  groups[gIdx] = { ...groups[gIdx], items };\r\n  setCatalog(tenantId, { ...cat, optionGroups: groups });\r\n  return withGroup;\r\n}\r\n\r\n/** Search products across all tenants by name (contains, case-insensitive). */\r\nexport function searchProductsAcrossTenants(query: string): Array<{ tenantId: string; product: Product }> {\r\n  const q = query.trim().toLowerCase();\r\n  if (!q) return [];\r\n  const data = load();\r\n  const results: Array<{ tenantId: string; product: Product }> = [];\r\n  for (const tenantId of Object.keys(data)) {\r\n    const products = data[tenantId].products ?? [];\r\n    for (const p of products) {\r\n      if (p.name.toLowerCase().includes(q)) {\r\n        results.push({ tenantId, product: p });\r\n      }\r\n    }\r\n  }\r\n  return results;\r\n}\r\n\r\nexport function deleteOptionItem(tenantId: string, groupId: string, itemId: string): void {\r\n  const cat = getCatalog(tenantId);\r\n  const groups = cat.optionGroups ?? [];\r\n  const gIdx = groups.findIndex((g) => g.id === groupId);\r\n  if (gIdx === -1) return;\r\n  const items = (groups[gIdx].items ?? []).filter((i) => i.id !== itemId);\r\n  groups[gIdx] = { ...groups[gIdx], items };\r\n  setCatalog(tenantId, { ...cat, optionGroups: groups });\r\n}\r\n"],"mappings":";AAEA,IAAM,cAAc;AASpB,SAAS,OAAsC;AAC7C,MAAI;AACF,UAAM,MAAM,aAAa,QAAQ,WAAW;AAC5C,UAAM,SAAS,MAAM,KAAK,MAAM,GAAG,IAAI,CAAC;AACxC,eAAW,KAAK,OAAO,KAAK,MAAM,GAAG;AACnC,UAAI,CAAC,OAAO,CAAC,EAAE,aAAc,QAAO,CAAC,EAAE,eAAe,CAAC;AACvD,UAAI,CAAC,OAAO,CAAC,EAAE,YAAa,QAAO,CAAC,EAAE,cAAc,CAAC;AAAA,IACvD;AACA,WAAO;AAAA,EACT,QAAQ;AAAA,EAER;AACA,SAAO,CAAC;AACV;AAEA,SAAS,KAAK,MAA2C;AACvD,eAAa,QAAQ,aAAa,KAAK,UAAU,IAAI,CAAC;AACxD;AAEA,SAAS,kBAAkB,GAAgC;AACzD,SAAO;AAAA,IACL,GAAG;AAAA,IACH,UAAU,EAAE,YAAY;AAAA,IACxB,WAAW,EAAE,aAAa;AAAA,EAC5B;AACF;AAEO,SAAS,WAAW,UAAiC;AAC1D,QAAM,OAAO,KAAK;AAClB,QAAM,MAAM,KAAK,QAAQ;AACzB,MAAI,CAAC,KAAK;AACR,WAAO,EAAE,YAAY,CAAC,GAAG,UAAU,CAAC,GAAG,cAAc,CAAC,GAAG,aAAa,CAAC,EAAE;AAAA,EAC3E;AACA,QAAM,cAAc,IAAI,cAAc,CAAC,GAAG,IAAI,CAAC,MAAM,kBAAkB,CAAC,CAAC;AACzE,SAAO;AAAA,IACL;AAAA,IACA,UAAU,IAAI,YAAY,CAAC;AAAA,IAC3B,cAAc,IAAI,gBAAgB,CAAC;AAAA,IACnC,aAAa,IAAI,eAAe,CAAC;AAAA,EACnC;AACF;AAGO,SAAS,oBAAoB,UAAiC;AACnE,QAAM,OAAO,KAAK;AAClB,MAAI,CAAC,KAAK,QAAQ,GAAG;AACnB,UAAM,QAAuB;AAAA,MAC3B,YAAY,CAAC;AAAA,MACb,UAAU,CAAC;AAAA,MACX,cAAc,CAAC;AAAA,MACf,aAAa,CAAC;AAAA,IAChB;AACA,SAAK,QAAQ,IAAI;AACjB,SAAK,IAAI;AACT,WAAO;AAAA,EACT;AACA,QAAM,MAAM,KAAK,QAAQ;AACzB,QAAM,aAA4B;AAAA,IAChC,YAAY,IAAI,cAAc,CAAC;AAAA,IAC/B,UAAU,IAAI,YAAY,CAAC;AAAA,IAC3B,cAAc,IAAI,gBAAgB,CAAC;AAAA,IACnC,aAAa,IAAI,eAAe,CAAC;AAAA,EACnC;AACA,MAAI,CAAC,IAAI,aAAa;AACpB,SAAK,QAAQ,IAAI;AACjB,SAAK,IAAI;AAAA,EACX;AACA,SAAO;AACT;AAEO,SAAS,WAAW,UAAkB,SAA8B;AACzE,QAAM,OAAO,KAAK;AAClB,OAAK,QAAQ,IAAI;AAAA,IACf,GAAG;AAAA,IACH,YAAY,QAAQ,cAAc,CAAC;AAAA,IACnC,UAAU,QAAQ,YAAY,CAAC;AAAA,IAC/B,cAAc,QAAQ,gBAAgB,CAAC;AAAA,IACvC,aAAa,QAAQ,eAAe,CAAC;AAAA,EACvC;AACA,OAAK,IAAI;AACX;AAEO,SAAS,iBAAiB,UAAiC;AAChE,SAAO,WAAW,QAAQ,EAAE,gBAAgB,CAAC;AAC/C;AAEO,SAAS,uBAAuB,mBAA2B,SAAgC;AAChG,QAAM,WAAW,UAAU,oBAAoB;AAC/C,QAAM,MAAM,WAAW;AACvB,MAAI,UAAU;AACZ,UAAM,SAAS,WAAW,QAAQ,EAAE,gBAAgB,CAAC;AACrD,UAAM,IAAI,OAAO,KAAK,CAAC,MAAM,EAAE,OAAO,GAAG;AACzC,WAAO,GAAG,SAAS,CAAC;AAAA,EACtB;AACA,QAAM,UAAU,OAAO,KAAK,KAAK,CAAC;AAClC,aAAW,OAAO,SAAS;AACzB,UAAM,SAAS,WAAW,GAAG,EAAE,gBAAgB,CAAC;AAChD,UAAM,IAAI,OAAO,KAAK,CAAC,MAAM,EAAE,OAAO,GAAG;AACzC,QAAI,EAAG,QAAO,EAAE,SAAS,CAAC;AAAA,EAC5B;AACA,SAAO,CAAC;AACV;AAEO,SAAS,kBAAkB,UAAkB,OAAiC;AACnF,QAAM,MAAM,WAAW,QAAQ;AAC/B,QAAM,SAAS,IAAI,gBAAgB,CAAC;AACpC,QAAM,MAAM,OAAO,UAAU,CAAC,MAAM,EAAE,OAAO,MAAM,EAAE;AACrD,QAAM,aAAa,EAAE,GAAG,OAAO,SAAS;AACxC,MAAI,OAAO,GAAG;AACZ,WAAO,GAAG,IAAI,EAAE,GAAG,YAAY,OAAO,OAAO,GAAG,EAAE,SAAS,CAAC,EAAE;AAAA,EAChE,OAAO;AACL,WAAO,KAAK,EAAE,GAAG,YAAY,OAAO,MAAM,SAAS,CAAC,EAAE,CAAC;AAAA,EACzD;AACA,aAAW,UAAU,EAAE,GAAG,KAAK,cAAc,OAAO,CAAC;AACrD,SAAO,OAAO,OAAO,IAAI,MAAM,OAAO,SAAS,CAAC;AAClD;AAEO,SAAS,kBAAkB,UAAkB,SAAuB;AACzE,QAAM,MAAM,WAAW,QAAQ;AAC/B,QAAM,UAAU,IAAI,gBAAgB,CAAC,GAAG,OAAO,CAAC,MAAM,EAAE,OAAO,OAAO;AACtE,aAAW,UAAU,EAAE,GAAG,KAAK,cAAc,OAAO,CAAC;AACvD;AAEO,SAAS,iBAAiB,UAAkB,SAAiB,MAA8B;AAChG,QAAM,MAAM,WAAW,QAAQ;AAC/B,QAAM,SAAS,IAAI,gBAAgB,CAAC;AACpC,QAAM,OAAO,OAAO,UAAU,CAAC,MAAM,EAAE,OAAO,OAAO;AACrD,MAAI,SAAS,GAAI,QAAO;AACxB,QAAM,QAAQ,OAAO,IAAI,EAAE,SAAS,CAAC;AACrC,QAAM,OAAO,MAAM,UAAU,CAAC,MAAM,EAAE,OAAO,KAAK,EAAE;AACpD,QAAM,YAAY,EAAE,GAAG,MAAM,QAAQ;AACrC,MAAI,QAAQ,EAAG,OAAM,IAAI,IAAI;AAAA,MACxB,OAAM,KAAK,SAAS;AACzB,SAAO,IAAI,IAAI,EAAE,GAAG,OAAO,IAAI,GAAG,MAAM;AACxC,aAAW,UAAU,EAAE,GAAG,KAAK,cAAc,OAAO,CAAC;AACrD,SAAO;AACT;AAGO,SAAS,4BAA4B,OAA8D;AACxG,QAAM,IAAI,MAAM,KAAK,EAAE,YAAY;AACnC,MAAI,CAAC,EAAG,QAAO,CAAC;AAChB,QAAM,OAAO,KAAK;AAClB,QAAM,UAAyD,CAAC;AAChE,aAAW,YAAY,OAAO,KAAK,IAAI,GAAG;AACxC,UAAM,WAAW,KAAK,QAAQ,EAAE,YAAY,CAAC;AAC7C,eAAW,KAAK,UAAU;AACxB,UAAI,EAAE,KAAK,YAAY,EAAE,SAAS,CAAC,GAAG;AACpC,gBAAQ,KAAK,EAAE,UAAU,SAAS,EAAE,CAAC;AAAA,MACvC;AAAA,IACF;AAAA,EACF;AACA,SAAO;AACT;AAEO,SAAS,iBAAiB,UAAkB,SAAiB,QAAsB;AACxF,QAAM,MAAM,WAAW,QAAQ;AAC/B,QAAM,SAAS,IAAI,gBAAgB,CAAC;AACpC,QAAM,OAAO,OAAO,UAAU,CAAC,MAAM,EAAE,OAAO,OAAO;AACrD,MAAI,SAAS,GAAI;AACjB,QAAM,SAAS,OAAO,IAAI,EAAE,SAAS,CAAC,GAAG,OAAO,CAAC,MAAM,EAAE,OAAO,MAAM;AACtE,SAAO,IAAI,IAAI,EAAE,GAAG,OAAO,IAAI,GAAG,MAAM;AACxC,aAAW,UAAU,EAAE,GAAG,KAAK,cAAc,OAAO,CAAC;AACvD;","names":[]}