var de=a=>{throw TypeError(a)};var W=(a,e,r)=>e.has(a)||de("Cannot "+r);var i=(a,e,r)=>(W(a,e,"read from private field"),r?r.call(a):e.get(a)),E=(a,e,r)=>e.has(a)?de("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(a):e.set(a,r),I=(a,e,r,n)=>(W(a,e,"write to private field"),n?n.call(a,r):e.set(a,r),r),P=(a,e,r)=>(W(a,e,"access private method"),r);import{y as Pe,z as Se,A as ue,D as Me,F as ye,G as ke,r as c,H as Oe,I as Re,b as De,c as me,e as Ve,d as L,j as t,B as he,J as xe,k as S,i as Ke,v as qe,w as Ae,x as Le,M as Fe}from"./index-DqbWLIhh.js";import{u as pe}from"./cart-_Jxk0B-k.js";import{p as Te}from"./pricing-sLTXzm7K.js";var p,N,l,f,y,F,G,fe,Ye=(fe=class extends Pe{constructor(e,r){super();E(this,y);E(this,p);E(this,N);E(this,l);E(this,f);I(this,p,e),this.setOptions(r),this.bindMethods(),P(this,y,F).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var n;const r=this.options;this.options=i(this,p).defaultMutationOptions(e),Se(this.options,r)||i(this,p).getMutationCache().notify({type:"observerOptionsUpdated",mutation:i(this,l),observer:this}),r!=null&&r.mutationKey&&this.options.mutationKey&&ue(r.mutationKey)!==ue(this.options.mutationKey)?this.reset():((n=i(this,l))==null?void 0:n.state.status)==="pending"&&i(this,l).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=i(this,l))==null||e.removeObserver(this)}onMutationUpdate(e){P(this,y,F).call(this),P(this,y,G).call(this,e)}getCurrentResult(){return i(this,N)}reset(){var e;(e=i(this,l))==null||e.removeObserver(this),I(this,l,void 0),P(this,y,F).call(this),P(this,y,G).call(this)}mutate(e,r){var n;return I(this,f,r),(n=i(this,l))==null||n.removeObserver(this),I(this,l,i(this,p).getMutationCache().build(i(this,p),this.options)),i(this,l).addObserver(this),i(this,l).execute(e)}},p=new WeakMap,N=new WeakMap,l=new WeakMap,f=new WeakMap,y=new WeakSet,F=function(){var r;const e=((r=i(this,l))==null?void 0:r.state)??Me();I(this,N,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},G=function(e){ye.batch(()=>{var r,n,u,b,g,o,D,v;if(i(this,f)&&this.hasListeners()){const m=i(this,N).variables,w=i(this,N).context,C={client:i(this,p),meta:this.options.meta,mutationKey:this.options.mutationKey};if((e==null?void 0:e.type)==="success"){try{(n=(r=i(this,f)).onSuccess)==null||n.call(r,e.data,m,w,C)}catch(h){Promise.reject(h)}try{(b=(u=i(this,f)).onSettled)==null||b.call(u,e.data,null,m,w,C)}catch(h){Promise.reject(h)}}else if((e==null?void 0:e.type)==="error"){try{(o=(g=i(this,f)).onError)==null||o.call(g,e.error,m,w,C)}catch(h){Promise.reject(h)}try{(v=(D=i(this,f)).onSettled)==null||v.call(D,void 0,e.error,m,w,C)}catch(h){Promise.reject(h)}}}this.listeners.forEach(m=>{m(i(this,N))})})},fe);function Ue(a,e){const r=ke(),[n]=c.useState(()=>new Ye(r,a));c.useEffect(()=>{n.setOptions(a)},[n,a]);const u=c.useSyncExternalStore(c.useCallback(g=>n.subscribe(ye.batchCalls(g)),[n]),()=>n.getCurrentResult(),()=>n.getCurrentResult()),b=c.useCallback((g,o)=>{n.mutate(g,o).catch(Oe)},[n]);if(u.error&&Re(n.options.throwOnError,[u.error]))throw u.error;return{...u,mutate:b,mutateAsync:u.mutate}}const R=new Fe;function He(){var ie,oe;const a=De(),e=me(s=>s.tenantId)??"default",r=me(s=>s.tenantSlug)??e,n=pe(s=>s.getItems(e)),u=pe(s=>s.clearCart),b=Ve().addToast,{data:g}=L({queryKey:["campaigns",e],queryFn:()=>R.getCampaigns(e),enabled:!!e}),{data:o}=L({queryKey:["delivery",e],queryFn:()=>R.getDeliverySettings(e),enabled:!!e}),{data:D=[]}=L({queryKey:["delivery-zones",e],queryFn:()=>R.getDeliveryZones(e),enabled:!!e}),{data:v}=L({queryKey:["tenant",e],queryFn:()=>R.getTenant(e),enabled:!!e}),{priced:m,subtotal:w,discountTotal:C,total:h}=Te(n,g??[]),[d,H]=c.useState("PICKUP"),[T,Q]=c.useState(""),[Y,be]=c.useState(""),[U,ge]=c.useState(""),[B,ve]=c.useState(""),[J,je]=c.useState(""),[M,V]=c.useState({}),k=D.filter(s=>s.isActive),Z=((ie=o==null?void 0:o.modes)==null?void 0:ie.delivery)??!0,_=((oe=o==null?void 0:o.modes)==null?void 0:oe.pickup)??!0,Ne=(o==null?void 0:o.deliveryFee)??0,x=k.find(s=>s.id===T),K=d==="DELIVERY"?(x==null?void 0:x.fee)??Ne:0,Ce=h+K,X=d==="DELIVERY",ee=!(d==="DELIVERY"&&k.length>0)||T.length>0,te=X?B.trim():void 0,se=Y.trim().length>0,re=U.trim().length>0,$=!X||B.trim().length>0,ae=se&&re&&$&&ee,ne=Ue({mutationFn:()=>R.createOrder(e,{tenantId:e,items:m.map(s=>({...s.item,totalPrice:s.finalPrice*s.item.quantity})),fulfillmentType:d,paymentMethod:"CASH",notes:J.trim()||void 0,customerName:Y.trim()||void 0,customerPhone:U.trim()||void 0,deliveryAddress:te||void 0,delivery:{method:d,zoneId:x==null?void 0:x.id,zoneName:x==null?void 0:x.name,fee:d==="DELIVERY"?K:void 0,addressText:te}}),onSuccess:s=>{var j;u(e);const q=((j=v==null?void 0:v.branding)==null?void 0:j.whatsappPhone)??"";if(qe(q)&&v){b("تم إنشاء الطلب بنجاح","success");const O=Ae(s,v),z=Le(q,O);window.open(z,"_blank","noopener,noreferrer")}else b("تم حفظ الطلب، واتساب غير مُهيأ","info");a(r?`/${r}/order/${s.id}/success`:`/order/${s.id}/success`)},onError:()=>{b("حدث خطأ، يرجى المحاولة مرة أخرى","error")}}),we=()=>{V({name:!0,phone:!0,address:!0,zone:!0}),ae&&ne.mutate()};return!_&&!Z?t.jsx("div",{className:"max-w-2xl mx-auto p-8 text-center text-neutral-500",dir:"rtl",children:"لا يوجد طريقة توصيل متاحة"}):n.length===0?t.jsxs("div",{className:"max-w-2xl mx-auto p-8 text-center",dir:"rtl",children:[t.jsx("p",{className:"text-neutral-600 mb-6",children:"لا توجد عناصر في السلة"}),t.jsx(he,{onClick:()=>a(r?`/${r}`:"/"),children:"العودة للتسوق"})]}):t.jsxs("div",{className:"max-w-5xl mx-auto p-4",dir:"rtl",children:[t.jsx("h1",{className:"text-xl font-semibold text-gray-900 mb-6",children:"إتمام الطلب"}),t.jsxs("div",{className:"grid lg:grid-cols-[1fr,320px] gap-8",children:[t.jsxs("div",{className:"space-y-6",children:[t.jsxs("section",{children:[t.jsx("h2",{className:"text-sm font-medium text-gray-900 mb-3",children:"طريقة الاستلام"}),t.jsxs("div",{className:"flex gap-6",children:[_&&t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"radio",name:"fulfillment",value:"PICKUP",checked:d==="PICKUP",onChange:()=>H("PICKUP"),className:"w-4 h-4 text-primary border-neutral-300"}),t.jsx("span",{className:"text-sm text-gray-700",children:"استلام من المحل"})]}),Z&&t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"radio",name:"fulfillment",value:"DELIVERY",checked:d==="DELIVERY",onChange:()=>{var s;H("DELIVERY"),Q(((s=k[0])==null?void 0:s.id)??"")},className:"w-4 h-4 text-primary border-neutral-300"}),t.jsx("span",{className:"text-sm text-gray-700",children:"توصيل للمنزل"})]})]})]}),t.jsxs("section",{className:"space-y-4",children:[t.jsx("h2",{className:"text-sm font-medium text-gray-900",children:"معلومات العميل"}),t.jsx(xe,{label:"الاسم الكامل",value:Y,onChange:s=>be(s.target.value),onBlur:()=>V(s=>({...s,name:!0})),placeholder:"الاسم الكامل",error:M.name&&!se?"مطلوب":void 0}),t.jsx(xe,{label:"رقم الجوال",value:U,onChange:s=>ge(s.target.value),onBlur:()=>V(s=>({...s,phone:!0})),placeholder:"05xxxxxxxx",error:M.phone&&!re?"مطلوب":void 0}),d==="DELIVERY"&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 ms-1",children:"العنوان (مطلوب للتوصيل)"}),t.jsx("textarea",{value:B,onChange:s=>ve(s.target.value),onBlur:()=>V(s=>({...s,address:!0})),placeholder:"الشارع، الحي، المدينة",rows:3,className:`w-full ps-3 pe-3 py-2 rounded-[var(--radius)] border bg-white text-gray-900 placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none ${M.address&&!$?"border-red-500":"border-gray-300"}`}),M.address&&!$&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:"مطلوب للتوصيل"})]}),d==="DELIVERY"&&k.length>0&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 ms-1",children:"المنطقة"}),t.jsxs("select",{value:T,onChange:s=>Q(s.target.value),className:"w-full h-10 ps-3 pe-3 rounded-[var(--radius)] border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary",children:[t.jsx("option",{value:"",children:"اختر المنطقة"}),k.map(s=>t.jsxs("option",{value:s.id,children:[s.name," - ",S(s.fee),s.etaMinutes?` (${s.etaMinutes} د)`:""]},s.id))]}),M.zone&&!ee&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:"اختر المنطقة"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1 ms-1",children:"ملاحظات (اختياري)"}),t.jsx("textarea",{value:J,onChange:s=>je(s.target.value),placeholder:"ملاحظات إضافية للطلب",rows:3,className:"w-full ps-3 pe-3 py-2 rounded-[var(--radius)] border border-gray-300 bg-white text-gray-900 placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none"})]})]})]}),t.jsx("div",{className:"lg:sticky lg:top-24 self-start",children:t.jsxs("div",{className:"p-4 rounded-xl border border-neutral-200 bg-neutral-50/50",children:[t.jsx("h2",{className:"text-sm font-medium text-gray-900 mb-3",children:"ملخص الطلب"}),t.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto mb-4",children:m.map(({item:s,finalPrice:q})=>t.jsxs("div",{className:"flex justify-between items-start gap-2 text-sm",children:[t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsxs("span",{className:"text-gray-700 line-clamp-1 block",children:[s.productName," × ",s.quantity]}),s.selectedOptions.length>0&&t.jsx("p",{className:"text-xs text-neutral-500 mt-0.5 line-clamp-2",children:s.selectedOptions.map(j=>{const O=s.optionGroups.find(A=>A.id===j.optionGroupId),z="optionItemIds"in j?j.optionItemIds:[],Ee="optionPlacements"in j?j.optionPlacements??{}:{};return z.map(A=>{var ce;const le=(ce=O==null?void 0:O.items.find(Ie=>Ie.id===A))==null?void 0:ce.name;return le?Ke(le,Ee[A]):""}).filter(Boolean).join("، ")}).filter(Boolean).join(" • ")})]}),t.jsx("span",{className:"font-medium flex-shrink-0",children:S(q*s.quantity)})]},s.id))}),t.jsxs("div",{className:"space-y-2 text-sm border-t border-neutral-200 pt-3",children:[t.jsxs("div",{className:"flex justify-between text-neutral-600",children:[t.jsx("span",{children:"المجموع الفرعي"}),t.jsx("span",{children:S(w)})]}),C>0&&t.jsxs("div",{className:"flex justify-between text-primary",children:[t.jsx("span",{children:"الخصم"}),t.jsxs("span",{children:["-",S(C)]})]}),d==="DELIVERY"&&K>0&&t.jsxs("div",{className:"flex justify-between text-neutral-600",children:[t.jsx("span",{children:"رسوم التوصيل"}),t.jsx("span",{children:S(K)})]}),t.jsxs("div",{className:"flex justify-between items-center pt-2",children:[t.jsx("span",{className:"font-semibold text-gray-900",children:"المجموع النهائي"}),t.jsx("span",{className:"text-lg font-bold text-gray-900",children:S(Ce)})]})]}),t.jsx(he,{className:"w-full h-12 rounded-xl mt-4",onClick:we,loading:ne.isPending,disabled:!ae,children:"إتمام الطلب"})]})})]})]})}export{He as default};
