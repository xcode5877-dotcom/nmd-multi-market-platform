import{d as re,h as se,i as ae,p as ne,r,c as u,k as l,M as ie}from"./index-BYQekpkv.js";const n=new ie,oe="";function we(){const{id:t}=re(),i=se(),{addToast:a}=ae(),g=ne(),[ue,P]=r.useState(!1),[le,V]=r.useState(new Set),[ce,J]=r.useState(null),[de,U]=r.useState(!1),[j,Y]=r.useState(null),[B,$]=r.useState(""),[x,G]=r.useState(""),[W,fe]=r.useState(""),[z,me]=r.useState(""),[ye,ve]=r.useState("queue"),[A,Se]=r.useState(""),[C,Ee]=r.useState(""),[M,be]=r.useState(""),[f,qe]=r.useState(""),[I,ge]=r.useState(""),[p,Ce]=r.useState(""),[h,Me]=r.useState(""),[F,Ie]=r.useState(""),[D,pe]=r.useState("deliveredCountWeek"),[K,he]=r.useState("desc"),[Fe,H]=r.useState(null),{data:k}=u({queryKey:["me"],queryFn:()=>n.getMe(),enabled:!1}),O=(k==null?void 0:k.role)==="ROOT_ADMIN";!O||O&&(g!=null&&g.enabled);const{data:ke}=u({queryKey:["market",t],queryFn:()=>fetch(`${oe}/markets/${t}`,{headers:{Authorization:`Bearer ${localStorage.getItem("nmd-access-token")}`}}).then(e=>e.json()),enabled:!!t&&!1}),{data:X=[],isLoading:Ae}=u({queryKey:["market-orders",t],queryFn:()=>n.getMarketOrders(t),enabled:!!t&&!1,refetchInterval:8e3}),c=X.filter(e=>e.fulfillmentType==="DELIVERY"&&e.status!=="CANCELED"),{data:Z=[]}=u({queryKey:["dispatch-queue",t],queryFn:()=>n.getDispatchQueue(t),enabled:!!t&&!1,refetchInterval:8e3}),{data:ee=[]}=u({queryKey:["market-couriers",t],queryFn:()=>n.getMarketCouriers(t),enabled:!!t&&!1,refetchInterval:8e3}),{data:te=[],isLoading:De}=u({queryKey:["market-courier-stats",t],queryFn:()=>n.getMarketCourierStats(t),enabled:!!t&&!1,refetchInterval:8e3}),{data:Ke,isLoading:Oe}=u({queryKey:["market-leaderboard",t],queryFn:()=>n.getMarketLeaderboard(t,"week"),enabled:!!t&&!1,refetchInterval:8e3}),{data:Le=[]}=u({queryKey:["delivery-jobs",t],queryFn:()=>n.getDeliveryJobs(t),enabled:!!t&&!1}),{data:L=[]}=u({queryKey:["tenants"],queryFn:()=>n.listTenants(),enabled:!!t}),Q=r.useMemo(()=>new Map(L.map(e=>[e.id,e.name])),[L]),S=ee,w=S.filter(e=>e.isActive&&e.isAvailable!==!1).length;S.filter(e=>e.isActive&&e.isAvailable!==!1);const E=r.useMemo(()=>c.filter(e=>!e.courierId),[c]),b=r.useMemo(()=>c.filter(e=>e.courierId&&e.status!=="OUT_FOR_DELIVERY"&&e.status!=="DELIVERED"),[c]),R=r.useMemo(()=>c.filter(e=>e.status==="DELIVERED").length,[c]);r.useMemo(()=>({queue:E.length,assigned:b.length,delivered:R,availableCouriers:w}),[E.length,b.length,R,w]);const m=r.useMemo(()=>{const e=A.trim().toLowerCase();return s=>{if(e){const d=(s.id??"").toLowerCase(),o=(s.customerName??"").toLowerCase(),y=(Q.get(s.tenantId??"")??"").toLowerCase();if(!d.includes(e)&&!o.includes(e)&&!y.includes(e))return!1}return!(C&&s.tenantId!==C||M&&s.courierId!==M||f&&(f==="UNASSIGNED"&&s.courierId||f==="ASSIGNED"&&(!s.courierId||s.status==="OUT_FOR_DELIVERY"||s.status==="DELIVERED")||f==="PICKED_UP"&&s.status!=="OUT_FOR_DELIVERY"||f==="DELIVERED"&&s.status!=="DELIVERED"))}},[A,C,M,f,Q]);r.useMemo(()=>E.filter(m),[E,m]),r.useMemo(()=>b.filter(m),[b,m]),r.useMemo(()=>c.filter(m),[c,m]),r.useMemo(()=>S.filter(e=>!(I==="active"&&!e.isActive||I==="inactive"&&e.isActive||p==="available"&&e.isAvailable===!1||p==="busy"&&e.isAvailable!==!1)),[S,I,p]);const q=te,T=r.useMemo(()=>q.filter(e=>!(h==="active"&&!e.isActive||h==="inactive"&&e.isActive||F==="available"&&e.isAvailable===!1||F==="busy"&&e.isAvailable!==!1)),[q,h,F]);return r.useMemo(()=>new Map(q.map(e=>[e.id,e])),[q]),r.useMemo(()=>{const e=[...T],s=D,d=K==="asc"?1:-1,o=y=>{const v=y[s];return typeof v=="number"?v:0};return e.sort((y,v)=>{const N=o(y),_=o(v);return N!==_?d*(N-_):(y.name??"").localeCompare(v.name??"")}),e},[T,D,K]),l({mutationFn:e=>{const s=new Map;Z.forEach(o=>{o.id&&o.tenantId&&s.set(o.id,o.tenantId)});const d=e.map(o=>({orderId:o,tenantId:s.get(o)??""})).filter(o=>o.tenantId);return n.createDeliveryJob(t,d)},onSuccess:()=>{i.invalidateQueries({queryKey:["delivery-jobs",t]}),i.invalidateQueries({queryKey:["dispatch-queue",t]}),a("تم إنشاء المهمة","success"),P(!1),V(new Set)},onError:e=>a(e instanceof Error?e.message:"فشل","error")}),l({mutationFn:({jobId:e,courierId:s})=>n.assignDeliveryJob(t,e,s),onSuccess:()=>{i.invalidateQueries({queryKey:["delivery-jobs",t]}),i.invalidateQueries({queryKey:["dispatch-queue",t]}),a("تم التعيين","success"),J(null)},onError:e=>a(e instanceof Error?e.message:"فشل","error")}),l({mutationFn:({orderId:e,courierId:s,reassign:d})=>n.assignCourierToOrder(t,e,s,d),onSuccess:()=>{i.invalidateQueries({queryKey:["market-orders",t]}),i.invalidateQueries({queryKey:["dispatch-queue",t]}),i.invalidateQueries({queryKey:["market-couriers",t]}),a("تم تعيين السائق للطلب","success")},onError:e=>a(e instanceof Error?e.message:"فشل","error")}),l({mutationFn:({courierId:e,updates:s})=>n.patchMarketCourier(t,e,s),onSuccess:()=>{i.invalidateQueries({queryKey:["market-couriers",t]}),a("تم التحديث","success")},onError:e=>a(e instanceof Error?e.message:"فشل","error")}),l({mutationFn:()=>n.createMarketCourier(t,{name:B.trim(),phone:x.trim()||void 0}),onSuccess:()=>{i.invalidateQueries({queryKey:["market-couriers",t]}),a("تم إضافة السائق","success"),U(!1),$(""),G("")},onError:e=>a(e instanceof Error?e.message:"فشل","error")}),l({mutationFn:()=>n.patchMarketCourier(t,j.id,{name:W.trim(),phone:z.trim()||void 0}),onSuccess:()=>{i.invalidateQueries({queryKey:["market-couriers",t]}),a("تم تحديث السائق","success"),Y(null)},onError:e=>a(e instanceof Error?e.message:"فشل","error")}),l({mutationFn:({orderId:e,status:s})=>n.updateOrderStatus(e,s),onSuccess:()=>{i.invalidateQueries({queryKey:["market-orders",t]}),i.invalidateQueries({queryKey:["market-couriers",t]}),a("تم تحديث حالة الطلب","success")},onError:e=>a(e instanceof Error?e.message:"فشل","error")}),l({mutationFn:e=>n.unassignCourierFromOrder(t,e),onSuccess:()=>{i.invalidateQueries({queryKey:["market-orders",t]}),i.invalidateQueries({queryKey:["market-couriers",t]}),a("تم إلغاء تعيين السائق","success")},onError:e=>a(e instanceof Error?e.message:"فشل","error")}),l({mutationFn:({orderId:e,message:s})=>n.logOrderContact(t,e,s),onSuccess:()=>{i.invalidateQueries({queryKey:["market-orders",t]}),a("تم تسجيل التواصل","success"),H(null)},onError:e=>a(e instanceof Error?e.message:"فشل","error")}),null}export{we as default};
