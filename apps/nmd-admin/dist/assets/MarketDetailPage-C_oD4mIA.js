import{d as M,f as b,a as E,h as L,i as w,r as i,c as d,k as m,j as l,B as q,M as F}from"./index-BYQekpkv.js";import{a as I}from"./api-CiuOvftP.js";import{A as S}from"./arrow-left-D6cBPTnX.js";const T="",r=new F;function U(){const{id:a}=M(),{pathname:n}=b(),y=E(),u=L(),{addToast:t}=w();i.useMemo(()=>a?n.endsWith("/tenants")?"tenants":n.endsWith("/orders")?"orders":n.endsWith("/dispatch")?"dispatch":n.endsWith("/finance")?"finance":"details":"details",[a,n]);const[A,p]=i.useState(!1),[O,g]=i.useState(!1),[x,k]=i.useState(new Set),[K,h]=i.useState({name:"",slug:"",type:"GENERAL",primaryColor:"#0f766e",enabled:!0}),{data:N,isLoading:j,isError:v}=d({queryKey:["market",a],queryFn:()=>fetch(`${T}/markets/${a}`,{headers:I()}).then(e=>e.ok?e.json():Promise.reject(new Error(e.status===403?"Forbidden":"Not found"))),enabled:!!a&&!1}),{data:s}=d({queryKey:["me"],queryFn:()=>r.getMe(),enabled:!1}),C=(s==null?void 0:s.role)==="ROOT_ADMIN",{data:f=[],isLoading:R}=d({queryKey:["tenants"],queryFn:()=>r.listTenants()});f.filter(e=>e.marketId===a),f.filter(e=>!e.marketId||e.marketId!==a),C||(s==null||s.marketId);const{data:_=[],isLoading:P}=d({queryKey:["market-orders",a],queryFn:()=>r.getMarketOrders(a),enabled:!1});return m({mutationFn:async e=>{const o=e.slug.toLowerCase().replace(/\s/g,"-")||e.name.toLowerCase().replace(/\s/g,"-");return r.createTenantForMarket(a,{name:e.name,slug:o,logoUrl:"",primaryColor:e.primaryColor,secondaryColor:"#d4a574",fontFamily:'"Cairo", system-ui, sans-serif',radiusScale:1,layoutStyle:"default",enabled:e.enabled,type:e.type})},onSuccess:e=>{u.invalidateQueries({queryKey:["tenants"]}),t("تم إنشاء المستأجر","success"),g(!1),h({name:"",slug:"",type:"GENERAL",primaryColor:"#0f766e",enabled:!0}),y(`/markets/${a}/tenants/${e.id}`)},onError:e=>{t((e==null?void 0:e.message)??"فشل الإنشاء","error")}}),m({mutationFn:async e=>{for(const o of e)if(await r.updateTenant(o,{marketId:a,isListedInMarket:!0})===null)throw new Error("فشل الحفظ")},onSuccess:()=>{u.invalidateQueries({queryKey:["tenants"]}),t("تم الحفظ","success"),p(!1),k(new Set)},onError:e=>{t((e==null?void 0:e.message)??"فشل الحفظ","error")}}),m({mutationFn:async({tenantId:e,updates:o})=>{const c=await r.updateTenant(e,o);if(c===null)throw new Error("فشل الحفظ");return c},onSuccess:()=>{u.invalidateQueries({queryKey:["tenants"]}),t("تم الحفظ","success")},onError:e=>{t((e==null?void 0:e.message)??"فشل الحفظ","error")}}),a?l.jsxs("div",{className:"py-8",children:[l.jsx(q,{variant:"ghost",size:"sm",onClick:()=>y("/markets"),className:"mb-4",children:l.jsx(S,{className:"w-4 h-4"})}),l.jsx("div",{className:"p-4 rounded-lg bg-amber-50 border border-amber-200 text-amber-800",children:"لتشغيل هذه الصفحة، ضبط VITE_MOCK_API_URL (مثال: http://localhost:5190)"})]}):null}export{U as default};
