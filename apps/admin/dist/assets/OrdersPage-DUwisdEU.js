import{u as R,a as U,r as d,b as T,c as _,j as e,B as i,I as q,f as b,P as W,F as $,C as G,E as V,D as H,d as K,e as Q,g as O,h as Y,i as J,k as X,m as Z,n as ee,M as se}from"./index-D0pSccYm.js";const w=new se,I=!1,M=["PENDING","CONFIRMED","COMPLETED","CANCELLED"],z={PENDING:"جديد",CONFIRMED:"تم التواصل",COMPLETED:"تم التسليم",CANCELLED:"ملغي"};function ne(){const{tenantId:a}=R();U();const[l,g]=d.useState("today"),[p,y]=d.useState(""),[x,N]=d.useState(""),[u,h]=d.useState(0),[c,o]=d.useState(null),[m,j]=d.useState(null),{data:v}=T({queryKey:["tenant",a],queryFn:()=>w.getTenant(a),enabled:!!a}),{data:E=[]}=T({queryKey:["orders",a,u],queryFn:()=>w.listOrdersByTenant(a),enabled:!!a&&I});let t=d.useMemo(()=>_(a),[a,u]);if(l==="today"){const s=new Date().toDateString();t=t.filter(n=>new Date(n.createdAt).toDateString()===s)}if(t=t.sort((s,n)=>new Date(n.createdAt).getTime()-new Date(s.createdAt).getTime()),p&&(t=t.filter(s=>s.status===p)),x.trim()){const s=x.trim().toLowerCase();t=t.filter(n=>n.id.toLowerCase().includes(s)||(n.customerName??"").toLowerCase().includes(s)||(n.customerPhone??"").replace(/\D/g,"").includes(s.replace(/\D/g,"")))}const r=async(s,n)=>{O(s.id,n),h(L=>L+1),j(null),(c==null?void 0:c.id)===s.id&&o(null)},f=t.map(s=>({orderId:e.jsx("span",{className:"font-mono text-sm font-medium",children:s.id.slice(0,8)}),date:e.jsx("span",{className:"text-gray-500 text-sm",children:new Date(s.createdAt).toLocaleString("ar-SA")}),customer:e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium text-gray-900",children:s.customerName||"—"}),s.customerPhone&&e.jsx("span",{className:"block text-gray-500 text-xs",dir:"ltr",children:s.customerPhone})]}),items:e.jsxs("span",{className:"text-sm text-gray-600",children:[s.items.length," ",s.items.length===1?"منتج":"منتجات"]}),total:e.jsx("span",{className:"font-bold text-primary",children:b(s.total)}),status:e.jsx(q,{status:s.status}),actions:e.jsxs("div",{className:"flex gap-1.5 flex-wrap",onClick:n=>n.stopPropagation(),children:[s.status!=="CONFIRMED"&&s.status!=="CANCELLED"&&e.jsx(i,{variant:"outline",size:"sm",className:"text-xs h-7 px-2 rounded-lg border-gray-300 hover:border-primary hover:bg-primary/5",onClick:()=>r(s,"CONFIRMED"),children:"تم التواصل"}),s.status!=="COMPLETED"&&s.status!=="CANCELLED"&&e.jsx(i,{variant:"outline",size:"sm",className:"text-xs h-7 px-2 rounded-lg border-gray-300 hover:border-primary hover:bg-primary/5",onClick:()=>r(s,"COMPLETED"),children:"تم التسليم"}),s.status!=="CANCELLED"&&e.jsx(i,{variant:"ghost",size:"sm",className:"text-xs h-7 px-2 rounded-lg text-red-600 hover:bg-red-50",onClick:()=>j(s),children:"إلغاء"})]})}));return e.jsxs("div",{children:[e.jsx(W,{title:"الطلبات",subtitle:l==="today"?"طلبات اليوم":"جميع الطلبات"}),e.jsx($,{search:e.jsx("input",{type:"text",placeholder:"بحث بالاسم أو الجوال أو رقم الطلب",value:x,onChange:s=>N(s.target.value),className:"border rounded px-3 py-2 text-sm w-full max-w-[220px]",dir:"rtl"}),chips:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(i,{variant:l==="today"?"primary":"outline",size:"sm",onClick:()=>g("today"),children:"اليوم"}),e.jsx(i,{variant:l==="all"?"primary":"outline",size:"sm",onClick:()=>g("all"),children:"الكل"})]}),selects:e.jsxs("select",{value:p,onChange:s=>y(s.target.value),className:"border rounded px-3 py-2 text-sm min-w-[140px]",children:[e.jsx("option",{value:"",children:"كل الحالات"}),M.map(s=>e.jsx("option",{value:s,children:z[s]},s))]})}),e.jsx(G,{children:e.jsx("div",{className:"p-4",children:t.length===0?e.jsx(V,{variant:"no-data",title:"لا توجد طلبات"}):e.jsx(H,{columns:[{key:"orderId",label:"رقم"},{key:"date",label:"التاريخ"},{key:"customer",label:"العميل"},{key:"items",label:"العناصر"},{key:"total",label:"المجموع"},{key:"status",label:"الحالة"},{key:"actions",label:"إجراءات",className:"w-48"}],rows:f,onRowClick:(s,n)=>o(t[n]),emptyMessage:"لا توجد طلبات"})})}),e.jsx(K,{open:!!c,onClose:()=>o(null),title:c?`طلب #${c.id.slice(0,8)}`:"",side:"start",children:c&&e.jsx(te,{order:c,tenant:v,onStatusChange:()=>{h(s=>s+1),o(null)},useApi:I})}),e.jsx(Q,{open:!!m,onClose:()=>j(null),onConfirm:()=>m&&r(m,"CANCELLED"),title:"إلغاء الطلب",message:m?`هل أنت متأكد من إلغاء الطلب #${m.id.slice(0,8)}؟`:"",confirmLabel:"إلغاء الطلب",variant:"danger"})]})}function te({order:a,tenant:l,onStatusChange:g,useApi:p}){var D;const[y,x]=d.useState(!1),N=Y().addToast,u=l?J(a,l):"",h=((D=l==null?void 0:l.branding)==null?void 0:D.whatsappPhone)??"",o=X(h)?Z(h,u):null,m=l?`/order/${a.id}/print?tenant=${l.slug}`:`/order/${a.id}/print`,j=()=>{navigator.clipboard.writeText(u),N("تم نسخ الرسالة","success")},v=()=>{var r;const t=((r=a.customerPhone)==null?void 0:r.trim())??"";t&&(navigator.clipboard.writeText(t),N("تم نسخ رقم الهاتف","success"))},E=async t=>{x(!0),p?await w.updateOrderStatus(a.id,t):O(a.id,t),g(),x(!1)};return e.jsxs("div",{className:"space-y-4",dir:"rtl",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700",children:"معلومات العميل"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الاسم"}),e.jsx("p",{className:"font-medium",children:a.customerName||"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الجوال"}),e.jsx("p",{dir:"ltr",className:"font-medium",children:a.customerPhone||"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"طريقة الاستلام"}),e.jsx("p",{className:"font-medium",children:a.fulfillmentType==="DELIVERY"?"توصيل":"استلام من المحل"})]}),a.fulfillmentType==="DELIVERY"&&(()=>{const t=a.delivery,r=(t==null?void 0:t.addressText)||a.deliveryAddress;return e.jsxs(e.Fragment,{children:[(t==null?void 0:t.zoneName)&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"المنطقة"}),e.jsx("p",{children:t.zoneName})]}),(t==null?void 0:t.fee)!=null&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"رسوم التوصيل"}),e.jsx("p",{children:b(t.fee)})]}),r&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"العنوان"}),e.jsx("p",{children:r})]})]})})(),a.notes&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"ملاحظات"}),e.jsx("p",{className:"text-sm text-gray-600",children:a.notes})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"العناصر"}),e.jsx("ul",{className:"space-y-2 border border-gray-200 rounded-lg p-3 bg-gray-50/50",children:a.items.map((t,r)=>{const f=(t.selectedOptions??[]).map(s=>{var A;const n=(A=t.optionGroups)==null?void 0:A.find(C=>C.id===s.optionGroupId),L="optionItemIds"in s?s.optionItemIds:[],F="optionPlacements"in s?s.optionPlacements??{}:{};return L.map(C=>{var k,P;const S=(P=(k=n==null?void 0:n.items)==null?void 0:k.find(B=>B.id===C))==null?void 0:P.name;return S?ee(S,F[C]):""}).filter(Boolean).join("، ")}).filter(Boolean).join(" | ");return e.jsxs("li",{className:"flex justify-between items-start text-sm gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("span",{children:[t.productName," × ",t.quantity]}),f&&e.jsx("span",{className:"block text-xs text-gray-500 mt-0.5",children:f})]}),e.jsx("span",{className:"font-medium flex-shrink-0",children:b(t.totalPrice)})]},r)})}),e.jsxs("div",{className:"flex justify-between items-center mt-2 pt-2 border-t border-gray-200",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"المجموع"}),e.jsx("span",{className:"font-bold text-primary text-lg",children:b(a.total)})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 pt-2 border-t border-gray-200",children:[o&&e.jsx(i,{variant:"outline",size:"sm",className:"bg-[#25D366]/10 text-[#25D366] border-[#25D366]/30 hover:bg-[#25D366]/20",onClick:()=>window.open(o,"_blank"),children:"فتح واتساب"}),e.jsx(i,{variant:"outline",size:"sm",onClick:j,children:"نسخ رسالة واتساب"}),a.customerPhone&&e.jsx(i,{variant:"outline",size:"sm",onClick:v,children:"نسخ رقم الهاتف"}),e.jsx(i,{variant:"outline",size:"sm",onClick:()=>window.open(m,"_blank"),children:"طباعة"})]}),e.jsxs("div",{className:"pt-4 border-t border-gray-200",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"تغيير الحالة"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[M.filter(t=>t!=="CANCELLED").map(t=>e.jsx(i,{variant:a.status===t?"primary":"outline",size:"sm",onClick:()=>E(t),disabled:y,children:z[t]},t)),a.status!=="CANCELLED"&&e.jsx(i,{variant:"ghost",size:"sm",className:"text-red-600",onClick:()=>E("CANCELLED"),disabled:y,children:"إلغاء"})]})]})]})}export{ne as default};
