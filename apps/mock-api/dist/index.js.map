{"version":3,"sources":["../src/index.ts","../src/store.ts","../src/delivery-engine.ts"],"sourcesContent":["import express from 'express';\nimport cors from 'cors';\nimport multer from 'multer';\nimport jwt from 'jsonwebtoken';\nimport { join } from 'path';\nimport { existsSync, mkdirSync } from 'fs';\nimport {\n  getMarkets,\n  setMarkets,\n  getTenants,\n  setTenants,\n  getUsers,\n  setUsers,\n  getAuditEvents,\n  appendAuditEvent,\n  getCatalog,\n  setCatalog,\n  getOrders,\n  setOrders,\n  getCampaigns,\n  setCampaigns,\n  getDelivery,\n  setDelivery,\n  getDeliveryZones,\n  setDeliveryZones,\n  getCouriers,\n  setCouriers,\n  getDeliveryJobs,\n  setDeliveryJobs,\n  type RegistryTenant,\n  type TenantCatalog,\n  type StorefrontHero,\n  type StorefrontBanner,\n  type DeliveryZoneRecord,\n  type Market,\n  type User,\n  type Courier,\n  type DeliveryJob,\n} from './store.js';\nimport { getDispatchQueue } from './delivery-engine.js';\n\nconst PORT = Number(process.env.PORT ?? 5190);\nconst JWT_SECRET = process.env.JWT_SECRET ?? 'nmd-dev-secret-change-in-production';\nconst app = express();\n\nconst DABBURIYYA_MARKET_ID = 'market-dabburiyya';\nconst IKSAL_MARKET_ID = 'market-iksal';\nconst ROOT_ADMIN_ID = 'user-root-admin';\n\nconst BUFFALO28_TENANT_ID = '78463821-ccb7-48af-841b-84a18c42abb6';\nconst OBR_TENANT_ID = '3f801fb9-f6f9-4e81-b3a2-f8954498cdac';\nconst TOP_MARKET_TENANT_ID = '60904bcc-970a-45e3-8669-8015ee2afe64';\n\nfunction seedUsersIfNeeded(): void {\n  const users = getUsers();\n  const seeds: User[] = [\n    { id: ROOT_ADMIN_ID, email: 'root@nmd.com', role: 'ROOT_ADMIN', password: '123456' },\n    { id: 'user-dab-admin', email: 'dab@nmd.com', role: 'MARKET_ADMIN', marketId: DABBURIYYA_MARKET_ID, password: '123456' },\n    { id: 'user-iks-admin', email: 'iks@nmd.com', role: 'MARKET_ADMIN', marketId: IKSAL_MARKET_ID, password: '123456' },\n    { id: 'user-buffalo-admin', email: 'buffalo@nmd.com', role: 'TENANT_ADMIN', tenantId: BUFFALO28_TENANT_ID, password: '123456' },\n    { id: 'user-tenant-ms-brands', email: 'ms-brands@nmd.com', role: 'TENANT_ADMIN', tenantId: '5b35539f-90e1-49cc-8c32-8d26cdce20f2', password: 'ms-brands@2026' },\n    { id: 'user-tenant-obr', email: 'obr@nmd.com', role: 'TENANT_ADMIN', tenantId: OBR_TENANT_ID, password: 'obr@2026' },\n    { id: 'user-tenant-top-market', email: 'top-market@nmd.com', role: 'TENANT_ADMIN', tenantId: TOP_MARKET_TENANT_ID, password: 'top-market@2026' },\n    { id: 'user-courier-dab-1', email: 'ahmed@courier.nmd.com', role: 'COURIER', marketId: DABBURIYYA_MARKET_ID, courierId: 'courier-50971b77-4811-49e8-825b-78bd84041782', password: '123456' },\n    { id: 'user-courier-iksal-1', email: 'courier@iksal.nmd.com', role: 'COURIER', marketId: IKSAL_MARKET_ID, courierId: 'courier-iksal-001', password: '123456' },\n  ];\n  if (users.length === 0) {\n    setUsers(seeds);\n    return;\n  }\n  // Migrate: ensure seed users exist with passwords\n  let changed = false;\n  const next = [...users];\n  for (const seed of seeds) {\n    const idx = next.findIndex((u) => u.email?.toLowerCase() === seed.email.toLowerCase() || u.id === seed.id);\n    if (idx >= 0) {\n      if (!next[idx].password) {\n        next[idx] = { ...next[idx], ...seed };\n        changed = true;\n      }\n    } else {\n      next.push(seed);\n      changed = true;\n    }\n  }\n  if (changed) setUsers(next);\n}\n\nfunction seedMarketsIfNeeded(): void {\n  const markets = getMarkets();\n  if (markets.length > 0) return;\n  const newMarkets: Market[] = [\n    { id: DABBURIYYA_MARKET_ID, name: 'سوق دبورية الرقمي', slug: 'dabburiyya', isActive: true, sortOrder: 0 },\n    { id: IKSAL_MARKET_ID, name: 'سوق إكسال الرقمي', slug: 'iksal', isActive: true, sortOrder: 1 },\n  ];\n  setMarkets(newMarkets);\n}\n\nfunction seedTenantMarketIdsIfNeeded(): void {\n  const dabburiyya = getMarkets().find((m) => m.slug === 'dabburiyya');\n  if (!dabburiyya) return;\n  const tenants = getTenants();\n  let changed = false;\n  for (const t of tenants) {\n    if (!t.marketId) {\n      (t as { marketId?: string }).marketId = dabburiyya.id;\n      (t as { isListedInMarket?: boolean }).isListedInMarket = true;\n      changed = true;\n    }\n  }\n  if (changed) setTenants(tenants);\n}\n\nfunction seedOrdersIfNeeded(): void {\n  const orders = getOrders() as { id?: string; tenantId?: string }[];\n  if (orders.length > 0) return;\n  const msBrands = getTenants().find((t) => (t as { slug?: string }).slug === 'ms-brands');\n  if (!msBrands?.marketId) return;\n  const seed = {\n    id: 'order-seed-delivery-1',\n    tenantId: msBrands.id,\n    marketId: msBrands.marketId,\n    status: 'PREPARING',\n    fulfillmentType: 'DELIVERY',\n    deliveryAssignmentMode: 'MARKET' as const,\n    total: 50,\n    subtotal: 45,\n    currency: 'ILS',\n    createdAt: new Date().toISOString(),\n    readyAt: new Date(Date.now() + 30 * 60 * 1000).toISOString(),\n    items: [],\n    customerName: 'Test',\n    customerPhone: '0501234567',\n  };\n  setOrders([seed]);\n}\n\nfunction seedDeliveryZonesIfNeeded(): void {\n  const tenants = getTenants();\n  for (const t of tenants) {\n    const existing = getDeliveryZones(t.id);\n    if (existing.length > 0) continue;\n    const slug = (t as { slug?: string }).slug ?? '';\n    let zones: DeliveryZoneRecord[] = [];\n    if (slug === 'buffalo-28' || slug === 'pizza') {\n      zones = [\n        { id: `dz-${t.id}-1`, tenantId: t.id, name: 'المنطقة الوسطى', fee: 15, etaMinutes: 30, isActive: true, sortOrder: 0 },\n        { id: `dz-${t.id}-2`, tenantId: t.id, name: 'الشمال', fee: 20, etaMinutes: 45, isActive: true, sortOrder: 1 },\n        { id: `dz-${t.id}-3`, tenantId: t.id, name: 'الجنوب', fee: 18, etaMinutes: 40, isActive: true, sortOrder: 2 },\n        { id: `dz-${t.id}-4`, tenantId: t.id, name: 'الشرق', fee: 22, etaMinutes: 50, isActive: true, sortOrder: 3 },\n        { id: `dz-${t.id}-5`, tenantId: t.id, name: 'الغرب', fee: 25, etaMinutes: 55, isActive: true, sortOrder: 4 },\n        { id: `dz-${t.id}-6`, tenantId: t.id, name: 'ضواحي', fee: 30, etaMinutes: 60, isActive: true, sortOrder: 5 },\n        { id: `dz-${t.id}-7`, tenantId: t.id, name: 'خارج المدينة', fee: 40, etaMinutes: 90, isActive: true, sortOrder: 6 },\n      ];\n    } else if (slug === 'ms-brands') {\n      zones = [{ id: `dz-${t.id}-1`, tenantId: t.id, name: 'التوصيل العام', fee: 10, etaMinutes: 45, isActive: true, sortOrder: 0 }];\n    } else {\n      zones = [\n        { id: `dz-${t.id}-1`, tenantId: t.id, name: 'المنطقة الافتراضية', fee: 10, etaMinutes: 45, isActive: true, sortOrder: 0 },\n      ];\n    }\n    setDeliveryZones(t.id, zones);\n  }\n}\n\nconst UPLOADS_DIR = join(process.cwd(), '..', '..', 'packages', 'mock', 'uploads');\nif (!existsSync(UPLOADS_DIR)) mkdirSync(UPLOADS_DIR, { recursive: true });\n\nconst storage = multer.diskStorage({\n  destination: (_req, _file, cb) => cb(null, UPLOADS_DIR),\n  filename: (_req, file, cb) => {\n    const ext = (file.originalname.match(/\\.([^.]+)$/)?.[1] ?? 'jpg').toLowerCase();\n    const name = `${Date.now()}-${Math.random().toString(36).slice(2, 10)}.${ext}`;\n    cb(null, name);\n  },\n});\n\nconst upload = multer({\n  storage,\n  limits: { fileSize: 5 * 1024 * 1024 },\n  fileFilter: (_req, file, cb) => {\n    if (file.mimetype.startsWith('image/')) cb(null, true);\n    else cb(new Error('Only image files allowed'));\n  },\n});\n\napp.use(cors());\napp.use(express.json({ limit: '1mb' }));\napp.use('/uploads', express.static(UPLOADS_DIR));\n\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: User;\n    }\n  }\n}\n\n/** Public routes: no auth required */\nconst PUBLIC_ROUTES: { method: string; path: RegExp }[] = [\n  { method: 'POST', path: /^\\/auth\\/login$/ },\n  { method: 'GET', path: /^\\/health$/ },\n  { method: 'GET', path: /^\\/storefront\\/tenants$/ },\n  { method: 'GET', path: /^\\/markets$/ },\n  { method: 'GET', path: /^\\/markets\\/by-slug\\/[^/]+$/ },\n  { method: 'GET', path: /^\\/markets\\/[^/]+\\/tenants$/ },\n  { method: 'GET', path: /^\\/tenants\\/by-slug\\/[^/]+$/ },\n  { method: 'GET', path: /^\\/tenants\\/by-id\\/[^/]+$/ },\n  { method: 'GET', path: /^\\/catalog\\/[^/]+$/ },\n  { method: 'POST', path: /^\\/orders$/ },\n  { method: 'GET', path: /^\\/campaigns$/ },\n  { method: 'GET', path: /^\\/delivery\\/[^/]+$/ },\n  { method: 'GET', path: /^\\/tenants\\/[^/]+\\/delivery-zones$/ },\n  { method: 'GET', path: /^\\/public\\/orders\\/[^/]+$/ },\n];\n\nfunction isPublicRoute(method: string, path: string): boolean {\n  return PUBLIC_ROUTES.some((r) => r.method === method && r.path.test(path));\n}\n\n/** Parse JWT from Authorization: Bearer <token>, set req.user */\napp.use((req, _res, next) => {\n  const header = req.headers.authorization;\n  const token = header?.startsWith('Bearer ') ? header.slice(7) : null;\n  if (token) {\n    try {\n      const decoded = jwt.verify(token, JWT_SECRET) as { sub: string };\n      const user = getUsers().find((u) => u.id === decoded.sub);\n      if (user) req.user = { ...user, password: undefined };\n    } catch {\n      req.user = undefined;\n    }\n  } else {\n    req.user = undefined;\n  }\n  (req as express.Request & { emergencyMode?: boolean; emergencyReason?: string }).emergencyMode =\n    String(req.headers['x-emergency-mode'] ?? '').toLowerCase() === 'true';\n  (req as express.Request & { emergencyMode?: boolean; emergencyReason?: string }).emergencyReason =\n    (req.body as { _meta?: { emergencyReason?: string } })?._meta?.emergencyReason ?? '';\n  next();\n});\n\n/** For GET /courier/events only: accept token via ?token= (EventSource cannot set headers) */\napp.use((req, res, next) => {\n  if (req.method !== 'GET' || req.path !== '/courier/events') return next();\n  if (req.user) return next();\n  const token = req.query.token as string | undefined;\n  if (!token) return next();\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET) as { sub: string };\n    const user = getUsers().find((u) => u.id === decoded.sub);\n    if (user) req.user = { ...user, password: undefined };\n  } catch {\n    /* leave req.user undefined -> require-auth will 401 */\n  }\n  next();\n});\n\n/** Require auth for non-public routes */\napp.use((req, res, next) => {\n  if (req.path.startsWith('/uploads')) return next();\n  if (isPublicRoute(req.method, req.path)) return next();\n  if (!req.user) return res.status(401).json({ error: 'Unauthorized' });\n  next();\n});\n\n// --- Auth ---\napp.post('/auth/login', (req, res) => {\n  const { email, password } = req.body as { email?: string; password?: string };\n  if (!email || !password) return res.status(400).json({ error: 'email and password required' });\n  const users = getUsers();\n  const user = users.find((u) => u.email?.toLowerCase() === String(email).trim().toLowerCase());\n  if (!user || user.password !== password) {\n    return res.status(401).json({ error: 'Invalid email or password' });\n  }\n  const token = jwt.sign(\n    { sub: user.id },\n    JWT_SECRET,\n    { expiresIn: '7d' }\n  );\n  res.json({ accessToken: token });\n});\n\napp.get('/auth/me', (req, res) => {\n  if (!req.user) return res.status(401).json({ error: 'Unauthorized' });\n  const u = req.user as { id: string; email: string; role: string; marketId?: string; tenantId?: string; courierId?: string };\n  res.json({\n    id: u.id,\n    email: u.email,\n    role: u.role,\n    marketId: u.marketId,\n    tenantId: u.tenantId,\n    courierId: u.courierId,\n  });\n});\n\n// --- Courier portal (COURIER role only) ---\nfunction requireCourier(req: express.Request, res: express.Response): { courierId: string; marketId: string } | null {\n  const user = req.user as { role?: string; courierId?: string; marketId?: string } | undefined;\n  if (!user || user.role !== 'COURIER' || !user.courierId || !user.marketId) {\n    res.status(403).json({ error: 'Courier access required' });\n    return null;\n  }\n  return { courierId: user.courierId, marketId: user.marketId };\n}\n\napp.get('/courier/me', (req, res) => {\n  const scope = requireCourier(req, res);\n  if (!scope) return;\n  const courier = getCouriers().find((c) => c.id === scope.courierId);\n  const market = getMarkets().find((m) => m.id === scope.marketId);\n  if (!courier || !market) return res.status(404).json({ error: 'Courier or market not found' });\n  if (courier.marketId !== scope.marketId) return res.status(403).json({ error: 'Forbidden' });\n  res.json({\n    id: req.user!.id,\n    email: (req.user as { email: string }).email,\n    role: 'COURIER',\n    courierId: scope.courierId,\n    marketId: scope.marketId,\n    courier: { id: courier.id, name: courier.name, phone: courier.phone, isOnline: courier.isOnline, isAvailable: courier.isAvailable },\n    market: { id: market.id, name: market.name },\n  });\n});\n\napp.get('/courier/orders', (req, res) => {\n  const scope = requireCourier(req, res);\n  if (!scope) return;\n  const orders = (getOrders() as { id?: string; tenantId?: string; courierId?: string; status?: string; fulfillmentType?: string; total?: number; currency?: string; paymentMethod?: string; cashChangeFor?: number; customerName?: string; customerPhone?: string; deliveryAddress?: string; deliveryLocation?: { lat: number; lng: number } }[])\n    .filter((o) => o.fulfillmentType === 'DELIVERY' && o.courierId === scope.courierId && o.status !== 'CANCELED');\n  const tenants = getTenants() as { id?: string; name?: string; whatsappPhone?: string; addressLine?: string; location?: { lat: number; lng: number } }[];\n  const enriched = orders.map((o) => {\n    const t = o.tenantId ? tenants.find((x) => x.id === o.tenantId) : undefined;\n    const tenant = t ? { name: t.name ?? '', phone: t.whatsappPhone, address: t.addressLine, location: t.location } : { name: '', phone: undefined, address: undefined, location: undefined };\n    const customer = { name: o.customerName ?? '', phone: o.customerPhone ?? '', deliveryAddress: o.deliveryAddress ?? '', deliveryLocation: o.deliveryLocation };\n    const currency = o.currency ?? 'ILS';\n    const orderTotal = (o.payment as { financials?: { gross?: number } } | undefined)?.financials?.gross ?? (Number(o.total) || 0);\n    const paymentMethod = ((o.payment as { method?: string } | undefined)?.method ?? (o.paymentMethod === 'CARD' ? 'CARD' : 'CASH')) as 'CASH' | 'CARD';\n    const amountToCollect = paymentMethod === 'CASH' ? orderTotal : 0;\n    return { ...o, tenant, customer, currency, orderTotal, paymentMethod, amountToCollect, cashChangeFor: o.cashChangeFor };\n  });\n  res.json(enriched);\n});\n\n/** Courier's own performance stats (points, badges, metrics). */\napp.get('/courier/stats', (req, res) => {\n  const scope = requireCourier(req, res);\n  if (!scope) return;\n  const metrics = computeCourierMetrics(scope.marketId, scope.courierId);\n  res.json(metrics);\n});\n\n/** Valid action transitions by deliveryStatus (not order.status). */\nconst VALID_ACTION_FROM_DELIVERY: Record<string, string[]> = {\n  ASSIGNED: ['ACKNOWLEDGE'],\n  IN_PROGRESS: ['PICKED_UP'],\n  PICKED_UP: ['DELIVERED'],\n  DELIVERED: ['FINISH'],\n};\n\nfunction computeDurations(tl: { assignedAt?: string; acknowledgedAt?: string; pickedUpAt?: string; deliveredAt?: string }): Record<string, number> | undefined {\n  const a = tl.assignedAt ? new Date(tl.assignedAt).getTime() : 0;\n  const k = tl.acknowledgedAt ? new Date(tl.acknowledgedAt).getTime() : 0;\n  const p = tl.pickedUpAt ? new Date(tl.pickedUpAt).getTime() : 0;\n  const d = tl.deliveredAt ? new Date(tl.deliveredAt).getTime() : 0;\n  if (!a || !d) return undefined;\n  const mins = (x: number, y: number) => Math.round((y - x) / 60000);\n  const out: Record<string, number> = { totalMinutes: mins(a, d) };\n  if (k) out.assignedToAcknowledged = mins(a, k);\n  if (k && p) out.acknowledgedToPickedUp = mins(k, p);\n  if (p) out.pickedUpToDelivered = mins(p, d);\n  return out;\n}\n\n/** Legacy deliveryStatus -> action mapping for backward compatibility */\nconst DELIVERY_STATUS_TO_ACTION: Record<string, string> = {\n  ASSIGNED: 'ACKNOWLEDGE',\n  PICKED_UP: 'PICKED_UP',\n  DELIVERED: 'DELIVERED',\n};\n\nconst VALID_ACTIONS = ['ACKNOWLEDGE', 'PICKED_UP', 'DELIVERED', 'FINISH'];\n\n/** Compute payment object for aggregator financial model. */\nfunction computePaymentForOrder(\n  order: { items?: { totalPrice?: number }[]; subtotal?: number; total?: number; delivery?: { fee?: number } },\n  tenantId: string\n): {\n  method: 'CASH' | 'CARD';\n  provider: string;\n  status: 'PENDING' | 'COLLECTED' | 'AUTHORIZED' | 'CAPTURED' | 'REFUNDED';\n  currency: string;\n  breakdown: { itemsTotal: number; deliveryFee: number; discount?: number; tax?: number };\n  financials: { gross: number; commission: number; gatewayFee: number; netToMerchant: number; netToMarket: number };\n} {\n  const itemsTotal = order.subtotal ?? (order.items ?? []).reduce((s, i) => s + (Number(i.totalPrice) || 0), 0);\n  const deliveryFee = order.delivery?.fee ?? (getDelivery()[tenantId] as { deliveryFee?: number } | undefined)?.deliveryFee ?? 0;\n  const gross = Number(order.total) || itemsTotal + deliveryFee;\n  const tenant = getTenants().find((t) => t.id === tenantId);\n  const cfg = tenant?.financialConfig ?? { commissionType: 'PERCENTAGE' as const, commissionValue: 10, deliveryFeeModel: 'TENANT' as const };\n  const commission = cfg.commissionType === 'PERCENTAGE' ? Math.round(gross * (cfg.commissionValue / 100) * 100) / 100 : cfg.commissionValue;\n  const gatewayFee = 0;\n  const isMarketFee = cfg.deliveryFeeModel === 'MARKET';\n  const netToMarket = commission + gatewayFee + (isMarketFee ? deliveryFee : 0);\n  const netToMerchant = gross - commission - gatewayFee - (isMarketFee ? deliveryFee : 0);\n  return {\n    method: 'CASH',\n    provider: 'NMD',\n    status: 'PENDING',\n    currency: 'ILS',\n    breakdown: { itemsTotal, deliveryFee },\n    financials: { gross, commission, gatewayFee, netToMerchant, netToMarket },\n  };\n}\n\napp.post('/courier/orders/:orderId/status', (req, res) => {\n  const scope = requireCourier(req, res);\n  if (!scope) return;\n  const { orderId } = req.params;\n  const body = (req.body ?? {}) as { action?: string; deliveryStatus?: string; notes?: string };\n  let action = body.action;\n  if (!action && body.deliveryStatus != null) {\n    action = DELIVERY_STATUS_TO_ACTION[body.deliveryStatus] ?? body.deliveryStatus;\n  }\n  if (!action) {\n    return res.status(400).json({ error: 'Missing action or deliveryStatus', code: 'BAD_REQUEST', details: { expected: ['action', 'deliveryStatus'] } });\n  }\n  if (!VALID_ACTIONS.includes(action)) {\n    return res.status(400).json({ error: 'Invalid action or deliveryStatus', code: 'BAD_REQUEST', details: { received: body.action ?? body.deliveryStatus, validActions: VALID_ACTIONS } });\n  }\n  const orders = getOrders() as { id?: string; courierId?: string; status?: string; deliveryStatus?: string; tenantId?: string; deliveryTimeline?: Record<string, unknown>; deliveredAt?: string }[];\n  const idx = orders.findIndex((o) => o.id === orderId);\n  if (idx === -1) return res.status(404).json({ error: 'Order not found' });\n  const order = orders[idx];\n  if (order.courierId !== scope.courierId) return res.status(403).json({ error: 'Order not assigned to you', code: 'FORBIDDEN' });\n  const currentDeliveryStatus = order.deliveryStatus ?? 'UNASSIGNED';\n  const allowed = VALID_ACTION_FROM_DELIVERY[currentDeliveryStatus];\n  if (!allowed?.includes(action)) {\n    return res.status(409).json({\n      error: `Invalid transition: ${currentDeliveryStatus} -> ${action}`,\n      code: 'INVALID_TRANSITION',\n      details: { currentDeliveryStatus, action, allowed },\n    });\n  }\n  const tl = { ...(order.deliveryTimeline as Record<string, unknown> || {}) };\n  const hasAck = !!tl.acknowledgedAt;\n  const hasPicked = !!tl.pickedUpAt;\n  const hasDelivered = !!tl.deliveredAt;\n  const hasClosed = !!tl.closedAt;\n  if (action === 'ACKNOWLEDGE' && hasAck) return res.json(order);\n  if (action === 'PICKED_UP' && hasPicked) return res.json(order);\n  if (action === 'DELIVERED' && hasDelivered) return res.json(order);\n  if (action === 'FINISH' && hasClosed) return res.json(order);\n  const now = new Date().toISOString();\n  if (action === 'ACKNOWLEDGE') tl.acknowledgedAt = tl.acknowledgedAt ?? now;\n  if (action === 'PICKED_UP') tl.pickedUpAt = tl.pickedUpAt ?? now;\n  if (action === 'DELIVERED') {\n    tl.deliveredAt = tl.deliveredAt ?? now;\n    tl.durations = computeDurations(tl as { assignedAt?: string; acknowledgedAt?: string; pickedUpAt?: string; deliveredAt?: string });\n    const couriers = getCouriers();\n    const cIdx = couriers.findIndex((c) => c.id === scope.courierId);\n    if (cIdx >= 0) {\n      couriers[cIdx] = { ...couriers[cIdx], isAvailable: true, deliveryCount: (couriers[cIdx].deliveryCount ?? 0) + 1 };\n      setCouriers(couriers);\n    }\n  }\n  if (action === 'FINISH') {\n    tl.closedAt = tl.closedAt ?? now;\n    if (!tl.durations && tl.deliveredAt) {\n      tl.durations = computeDurations(tl as { assignedAt?: string; acknowledgedAt?: string; pickedUpAt?: string; deliveredAt?: string });\n    }\n  }\n  const deliveryStatusMap: Record<string, string> = { ACKNOWLEDGE: 'IN_PROGRESS', PICKED_UP: 'PICKED_UP', DELIVERED: 'DELIVERED', FINISH: 'DELIVERED' };\n  const newDeliveryStatus = deliveryStatusMap[action] ?? currentDeliveryStatus;\n  const updated = { ...order, deliveryStatus: newDeliveryStatus, deliveryTimeline: tl };\n  if (action === 'DELIVERED') (updated as { deliveredAt?: string }).deliveredAt = tl.deliveredAt as string;\n  if (action === 'FINISH') {\n    const pay = (updated as { payment?: { status?: string; method?: string; cashLedger?: unknown } }).payment;\n    if (pay && (pay.method === 'CASH' || !pay.method)) {\n      (updated as Record<string, unknown>).payment = {\n        ...pay,\n        status: 'COLLECTED',\n        cashLedger: { collected: true, collectedAt: now, collectedByCourierId: scope.courierId },\n      };\n    }\n  }\n  orders[idx] = updated;\n  setOrders(orders);\n  res.json(orders[idx]);\n});\n\n/** SSE: courier events. Emits when order assigned to this courier. Auth via Bearer or ?token= query.\n *  Test: open courier app, login, SSE connects without 401. */\nconst courierEventListeners = new Map<string, (data: string) => void>();\n\napp.get('/courier/events', (req, res) => {\n  const scope = requireCourier(req, res);\n  if (!scope) return;\n  res.setHeader('Content-Type', 'text/event-stream');\n  res.setHeader('Cache-Control', 'no-cache');\n  res.setHeader('Connection', 'keep-alive');\n  res.flushHeaders();\n  const send = (data: string) => {\n    try {\n      res.write(`data: ${data}\\n\\n`);\n      res.flush?.();\n    } catch {\n      courierEventListeners.delete(scope.courierId);\n    }\n  };\n  courierEventListeners.set(scope.courierId, send);\n  send(JSON.stringify({ type: 'connected', courierId: scope.courierId }));\n  req.on('close', () => courierEventListeners.delete(scope.courierId));\n});\n\nexport function emitCourierAssigned(courierId: string, order: { id?: string; tenantId?: string }) {\n  const send = courierEventListeners.get(courierId);\n  if (send) send(JSON.stringify({ type: 'order_assigned', orderId: order.id, tenantId: order.tenantId }));\n}\n\nexport function emitCourierUnassigned(courierId: string, orderId: string) {\n  const send = courierEventListeners.get(courierId);\n  if (send) send(JSON.stringify({ type: 'order_unassigned', orderId }));\n}\n\n/** Change password (self-service). Requires auth. TENANT_ADMIN can change only their own. */\napp.post('/auth/change-password', (req, res) => {\n  if (!req.user) return res.status(401).json({ error: 'Unauthorized' });\n  const { currentPassword, newPassword } = req.body as { currentPassword?: string; newPassword?: string };\n  if (!currentPassword || !newPassword) {\n    return res.status(400).json({ error: 'currentPassword and newPassword required' });\n  }\n  const users = getUsers();\n  const user = users.find((u) => u.id === req.user!.id);\n  if (!user) return res.status(401).json({ error: 'User not found' });\n  if (user.password !== currentPassword) {\n    return res.status(400).json({ error: 'Current password is incorrect' });\n  }\n  const updated = users.map((u) =>\n    u.id === req.user!.id ? { ...u, password: newPassword } : u\n  );\n  setUsers(updated);\n  res.json({ ok: true });\n});\n\n/** ROOT_ADMIN: require emergency mode for writes. MARKET_ADMIN: always allowed (scope checked elsewhere). */\nfunction requireWrite(req: express.Request): boolean {\n  const user = req.user;\n  if (!user) return false;\n  if (user.role === 'MARKET_ADMIN') return true;\n  if (user.role === 'ROOT_ADMIN') {\n    const em = (req as express.Request & { emergencyMode?: boolean }).emergencyMode;\n    return em === true;\n  }\n  return false;\n}\n\nfunction getEmergencyReason(req: express.Request): string {\n  return (req as express.Request & { emergencyReason?: string }).emergencyReason?.trim() ?? '';\n}\n\n/** For ROOT_ADMIN writes: require emergency mode + non-empty reason. Returns false and sends response if invalid. */\nfunction requireWriteWithReason(req: express.Request, res: express.Response): boolean {\n  if (!requireWrite(req)) {\n    res.status(403).json({ error: 'Emergency mode required', code: 'EMERGENCY_MODE_REQUIRED' });\n    return false;\n  }\n  if (req.user?.role === 'ROOT_ADMIN' && !getEmergencyReason(req)) {\n    res.status(400).json({ error: 'emergencyReason is required in body _meta when emergency mode is on', code: 'EMERGENCY_REASON_REQUIRED' });\n    return false;\n  }\n  return true;\n}\n\nconst DEFAULT_HERO: StorefrontHero = {\n  title: 'مرحباً بك',\n  subtitle: 'اكتشف أفضل المنتجات لدينا',\n  ctaText: 'تسوق الآن',\n  ctaLink: '#',\n};\n\nfunction normalizeHero(h: StorefrontHero | undefined): StorefrontHero {\n  const base = h ?? DEFAULT_HERO;\n  const cta = (base as { ctaHref?: string }).ctaHref ?? base.ctaLink ?? '#';\n  return { ...base, ctaLink: cta, ctaHref: cta } as StorefrontHero;\n}\n\nfunction normalizeTenantResponse(t: RegistryTenant): RegistryTenant {\n  const type = (t.type === 'CLOTHING' || t.type === 'FOOD') ? t.type : 'GENERAL';\n  return {\n    ...t,\n    type,\n    hero: normalizeHero(t.hero),\n    banners: t.banners ?? [],\n  };\n}\n\n// --- Audit (ROOT only) ---\napp.get('/audit-events', (req, res) => {\n  if (req.user?.role !== 'ROOT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  const limit = Math.min(Number(req.query.limit) || 100, 500);\n  const events = getAuditEvents().slice(-limit).reverse();\n  res.json(events);\n});\n\n// --- Monitoring (ROOT only) ---\napp.get('/monitoring/stats', (req, res) => {\n  if (req.user?.role !== 'ROOT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  const markets = getMarkets();\n  const tenants = getTenants();\n  const orders = getOrders() as { id?: string; tenantId?: string; total?: number; createdAt?: string }[];\n  const stats = markets.map((m) => {\n    const marketTenants = tenants.filter((t) => t.marketId === m.id);\n    const tenantIds = new Set(marketTenants.map((t) => t.id));\n    const marketOrders = orders.filter((o) => o.tenantId && tenantIds.has(o.tenantId));\n    const revenue = marketOrders.reduce((sum, o) => sum + (Number(o.total) || 0), 0);\n    return {\n      marketId: m.id,\n      marketName: m.name,\n      tenantCount: marketTenants.length,\n      orderCount: marketOrders.length,\n      revenue,\n    };\n  });\n  res.json(stats);\n});\n\n// --- Users (ROOT only) ---\napp.get('/users', (req, res) => {\n  if (req.user?.role !== 'ROOT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  const users = getUsers().map((u) => ({ ...u, password: undefined }));\n  res.json(users);\n});\n\n// --- Markets ---\napp.get('/markets', (req, res) => {\n  const user = req.user;\n  let markets = getMarkets();\n  if (user?.role === 'MARKET_ADMIN' && user.marketId) {\n    markets = markets.filter((m) => m.id === user.marketId);\n  } else {\n    const all = req.query.all === 'true';\n    if (!all) markets = markets.filter((m) => m.isActive);\n  }\n  res.json([...markets].sort((a, b) => (a.sortOrder ?? 999) - (b.sortOrder ?? 999)));\n});\n\napp.post('/markets', (req, res) => {\n  if (req.user?.role !== 'ROOT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  if (!requireWriteWithReason(req, res)) return;\n  const body = req.body as { name: string; slug: string; branding?: unknown; isActive?: boolean; sortOrder?: number };\n  const id = crypto.randomUUID?.() ?? `market-${Date.now()}`;\n  const market: Market = {\n    id,\n    name: body.name ?? '',\n    slug: body.slug ?? id,\n    branding: body.branding,\n    isActive: body.isActive ?? true,\n    sortOrder: body.sortOrder,\n  };\n  const markets = getMarkets();\n  markets.push(market);\n  setMarkets(markets);\n  appendAuditEvent({\n    userId: req.user!.id,\n    role: req.user!.role,\n    action: 'create',\n    entity: 'market',\n    entityId: market.id,\n    reason: getEmergencyReason(req),\n    emergencyMode: true,\n    after: market,\n  });\n  res.status(201).json(market);\n});\n\napp.put('/markets/:id', (req, res) => {\n  if (req.user?.role !== 'ROOT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  if (!requireWriteWithReason(req, res)) return;\n  const { id } = req.params;\n  const body = req.body as Partial<Omit<Market, 'id'>>;\n  const markets = getMarkets();\n  const idx = markets.findIndex((m) => m.id === id);\n  if (idx === -1) return res.status(404).json({ error: 'Market not found' });\n  const before = markets[idx];\n  markets[idx] = { ...markets[idx], ...body };\n  setMarkets(markets);\n  appendAuditEvent({\n    userId: req.user!.id,\n    role: req.user!.role,\n    action: 'update',\n    entity: 'market',\n    entityId: id,\n    reason: getEmergencyReason(req),\n    emergencyMode: true,\n    before,\n    after: markets[idx],\n  });\n  res.json(markets[idx]);\n});\n\napp.get('/markets/by-slug/:slug', (req, res) => {\n  const market = getMarkets().find((m) => m.slug === req.params.slug);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (!market.isActive) return res.status(404).json({ error: 'Market not found' });\n  res.json(market);\n});\n\napp.get('/markets/:id', (req, res) => {\n  const market = getMarkets().find((m) => m.id === req.params.id);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== market.id) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  res.json(market);\n});\n\napp.get('/markets/:marketId/admins', (req, res) => {\n  if (req.user?.role !== 'ROOT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  const { marketId } = req.params;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  const admins = getUsers().filter((u) => u.role === 'MARKET_ADMIN' && u.marketId === marketId);\n  res.json(admins);\n});\n\napp.post('/markets/:marketId/admins', (req, res) => {\n  if (req.user?.role !== 'ROOT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  if (!requireWriteWithReason(req, res)) return;\n  const { marketId } = req.params;\n  const { email } = req.body as { email?: string };\n  if (!email || typeof email !== 'string' || !email.trim()) {\n    return res.status(400).json({ error: 'email is required' });\n  }\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  const users = getUsers();\n  const existing = users.find((u) => u.email.toLowerCase() === email.trim().toLowerCase());\n  if (existing) return res.status(409).json({ error: 'User with this email already exists' });\n  const id = `user-${crypto.randomUUID?.() ?? Date.now()}`;\n  const newUser: User = {\n    id,\n    email: email.trim().toLowerCase(),\n    role: 'MARKET_ADMIN',\n    marketId,\n  };\n  users.push(newUser);\n  setUsers(users);\n  appendAuditEvent({\n    userId: req.user!.id,\n    role: req.user!.role,\n    marketId,\n    action: 'create',\n    entity: 'user',\n    entityId: newUser.id,\n    reason: getEmergencyReason(req),\n    emergencyMode: true,\n    after: newUser,\n  });\n  res.status(201).json(newUser);\n});\n\napp.get('/markets/:marketId/tenants', (req, res) => {\n  const { marketId } = req.params;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  const tenants = getTenants()\n    .filter((t) => t.marketId === marketId && t.enabled && (t.isListedInMarket !== false))\n    .sort((a, b) => {\n      const soA = a.marketSortOrder ?? 999;\n      const soB = b.marketSortOrder ?? 999;\n      if (soA !== soB) return soA - soB;\n      return (a.name ?? '').localeCompare(b.name ?? '');\n    })\n    .map((t) => {\n      const n = normalizeTenantResponse(t);\n      return {\n        id: n.id,\n        slug: n.slug,\n        name: n.name,\n        type: (n.type === 'CLOTHING' || n.type === 'FOOD') ? n.type : 'GENERAL',\n        branding: { logoUrl: n.logoUrl ?? '', primaryColor: n.primaryColor ?? '#7C3AED' },\n        isActive: n.enabled,\n        marketCategory: n.marketCategory ?? 'GENERAL',\n      };\n    });\n  res.json(tenants);\n});\n\napp.post('/markets/:marketId/tenants', (req, res) => {\n  const { marketId } = req.params;\n  const user = req.user;\n  if (!user) return res.status(401).json({ error: 'Unauthorized' });\n  if (user.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n  if (user.role === 'MARKET_ADMIN' && user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  const input = req.body as Omit<RegistryTenant, 'id' | 'createdAt' | 'marketId'>;\n  const id = crypto.randomUUID?.() ?? `t-${Date.now()}`;\n  const tenant: RegistryTenant = {\n    ...input,\n    id,\n    marketId,\n    createdAt: new Date().toISOString(),\n    hero: input.hero ?? DEFAULT_HERO,\n    banners: input.banners ?? [],\n  };\n  const tenants = getTenants();\n  tenants.push(tenant);\n  setTenants(tenants);\n  const cat = getCatalog(tenant.id);\n  setCatalog(tenant.id, cat);\n  const delivery = getDelivery();\n  if (!delivery[tenant.id]) {\n    delivery[tenant.id] = {\n      tenantId: tenant.id,\n      modes: { pickup: true, delivery: true },\n      deliveryFee: 5,\n      zones: [],\n    };\n    setDelivery(delivery);\n  }\n  appendAuditEvent({\n    userId: user.id,\n    role: user.role,\n    marketId,\n    action: 'create',\n    entity: 'tenant',\n    entityId: tenant.id,\n    reason: user.role === 'ROOT_ADMIN' ? getEmergencyReason(req) : undefined,\n    emergencyMode: user.role === 'ROOT_ADMIN',\n    after: tenant,\n  });\n  res.status(201).json(tenant);\n});\n\n// --- Tenants ---\napp.get('/tenants', (req, res) => {\n  let tenants = getTenants();\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId) {\n    tenants = tenants.filter((t) => t.marketId === req.user!.marketId);\n  }\n  res.json(tenants.map(normalizeTenantResponse));\n});\n\n/** Storefront/Market: list active tenants with id, slug, name, type, branding.logoUrl, isActive */\napp.get('/storefront/tenants', (_req, res) => {\n  const tenants = getTenants()\n    .filter((t) => t.enabled)\n    .map((t) => {\n      const n = normalizeTenantResponse(t);\n        return {\n        id: n.id,\n        slug: n.slug,\n        name: n.name,\n        type: (n.type === 'CLOTHING' || n.type === 'FOOD') ? n.type : 'GENERAL',\n        branding: { logoUrl: n.logoUrl ?? '', primaryColor: n.primaryColor ?? '#7C3AED' },\n        isActive: n.enabled,\n        marketCategory: n.marketCategory ?? 'GENERAL',\n      };\n    });\n  res.json(tenants);\n});\n\napp.post('/tenants', (req, res) => {\n  const user = req.user;\n  if (!user) return res.status(401).json({ error: 'Unauthorized' });\n  if (user.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n  const input = req.body as Omit<RegistryTenant, 'id' | 'createdAt'> & { marketId?: string };\n  let marketId: string | undefined;\n  if (user.role === 'MARKET_ADMIN' && user.marketId) {\n    marketId = user.marketId;\n    if (input.marketId && input.marketId !== user.marketId) {\n      return res.status(403).json({ error: 'Forbidden' });\n    }\n  } else {\n    marketId = input.marketId;\n    if (!marketId || !marketId.trim()) {\n      return res.status(400).json({ error: 'marketId is required', code: 'MARKET_ID_REQUIRED' });\n    }\n    const market = getMarkets().find((m) => m.id === marketId);\n    if (!market) return res.status(400).json({ error: 'Invalid marketId' });\n  }\n  const id = crypto.randomUUID?.() ?? `t-${Date.now()}`;\n  const tenant: RegistryTenant = {\n    ...input,\n    id,\n    marketId: marketId!,\n    createdAt: new Date().toISOString(),\n    hero: input.hero ?? DEFAULT_HERO,\n    banners: input.banners ?? [],\n  };\n  const tenants = getTenants();\n  tenants.push(tenant);\n  setTenants(tenants);\n  // Ensure catalog entry\n  const cat = getCatalog(tenant.id);\n  setCatalog(tenant.id, cat);\n  // Ensure delivery entry\n  const delivery = getDelivery();\n  if (!delivery[tenant.id]) {\n    delivery[tenant.id] = {\n      tenantId: tenant.id,\n      modes: { pickup: true, delivery: true },\n      deliveryFee: 5,\n      zones: [],\n    };\n    setDelivery(delivery);\n  }\n  appendAuditEvent({\n    userId: req.user!.id,\n    role: req.user!.role,\n    marketId: tenant.marketId,\n    action: 'create',\n    entity: 'tenant',\n    entityId: tenant.id,\n    reason: user.role === 'ROOT_ADMIN' ? getEmergencyReason(req) : undefined,\n    emergencyMode: user.role === 'ROOT_ADMIN',\n    after: tenant,\n  });\n  res.status(201).json(tenant);\n});\n\nfunction handleTenantUpdate(req: express.Request, res: express.Response): void {\n  const { id } = req.params;\n  let updates = req.body as Partial<Omit<RegistryTenant, 'id' | 'createdAt'>>;\n  const tenants = getTenants();\n  const idx = tenants.findIndex((t) => t.id === id);\n  if (idx === -1) {\n    res.status(404).json({ error: 'Tenant not found' });\n    return;\n  }\n  const tenant = tenants[idx];\n  const user = req.user;\n\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  if (user?.role === 'MARKET_ADMIN') {\n    if (tenant.marketId !== user.marketId) {\n      res.status(403).json({ error: 'Forbidden' });\n      return;\n    }\n    // MARKET_ADMIN can only update: marketCategory, isListedInMarket, marketSortOrder\n    const allowed = ['marketCategory', 'isListedInMarket', 'marketSortOrder'] as const;\n    updates = Object.fromEntries(\n      Object.entries(updates).filter(([k]) => allowed.includes(k as (typeof allowed)[number]))\n    ) as Partial<RegistryTenant>;\n  }\n\n  const before = { ...tenants[idx] };\n  tenants[idx] = { ...tenants[idx], ...updates };\n  setTenants(tenants);\n  appendAuditEvent({\n    userId: user!.id,\n    role: user!.role,\n    marketId: tenant.marketId,\n    action: 'update',\n    entity: 'tenant',\n    entityId: id,\n    reason: user!.role === 'ROOT_ADMIN' ? getEmergencyReason(req) : undefined,\n    emergencyMode: user!.role === 'ROOT_ADMIN',\n    before,\n    after: tenants[idx],\n  });\n  res.json(normalizeTenantResponse(tenants[idx]));\n}\n\napp.put('/tenants/:id', handleTenantUpdate);\napp.patch('/tenants/:id', handleTenantUpdate);\n\napp.post('/tenants/:id/toggle', (req, res) => {\n  const { id } = req.params;\n  const user = req.user;\n  const tenants = getTenants();\n  const idx = tenants.findIndex((t) => t.id === id);\n  if (idx === -1) return res.status(404).json({ error: 'Tenant not found' });\n  const tenant = tenants[idx];\n  if (user?.role === 'MARKET_ADMIN' && tenant.marketId !== user.marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n  const before = { ...tenants[idx] };\n  tenants[idx] = { ...tenants[idx], enabled: !tenants[idx].enabled };\n  setTenants(tenants);\n  appendAuditEvent({\n    userId: user!.id,\n    role: user!.role,\n    marketId: tenant.marketId,\n    action: 'update',\n    entity: 'tenant',\n    entityId: id,\n    reason: user!.role === 'ROOT_ADMIN' ? getEmergencyReason(req) : undefined,\n    emergencyMode: user!.role === 'ROOT_ADMIN',\n    before,\n    after: tenants[idx],\n  });\n  res.json(normalizeTenantResponse(tenants[idx]));\n});\n\napp.get('/tenants/by-id/:id', (req, res) => {\n  const tenant = getTenants().find((t) => t.id === req.params.id);\n  if (!tenant) return res.status(404).json({ error: 'Tenant not found' });\n  if (req.user?.role === 'TENANT_ADMIN' && req.user.tenantId !== req.params.id) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (req.user?.role === 'MARKET_ADMIN' && tenant.marketId !== req.user.marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  res.json(normalizeTenantResponse(tenant));\n});\n\napp.get('/tenants/by-slug/:slug', (req, res) => {\n  const slug = req.params.slug;\n  let tenant = getTenants().find((t) => t.slug === slug);\n  if (!tenant && slug === 'top-market') {\n    tenant = getTenants().find((t) => t.id === TOP_MARKET_TENANT_ID);\n  }\n  if (!tenant) return res.status(404).json({ error: 'Tenant not found' });\n  if (req.user?.role === 'MARKET_ADMIN' && tenant.marketId !== req.user.marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  res.json(normalizeTenantResponse(tenant));\n});\n\napp.put('/tenants/:id/branding', (req, res) => {\n  const { id } = req.params;\n  const user = req.user;\n  const tenants = getTenants();\n  const t = tenants.find((x) => x.id === id);\n  if (!t) return res.status(404).json({ error: 'Tenant not found' });\n  if (user?.role === 'MARKET_ADMIN' && t.marketId !== user.marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n  const { logoUrl, hero, banners, whatsappPhone } = req.body as { logoUrl?: string; hero?: StorefrontHero; banners?: StorefrontBanner[]; whatsappPhone?: string };\n  const idx = tenants.findIndex((x) => x.id === id);\n  if (idx === -1) return res.status(404).json({ error: 'Tenant not found' });\n  if (logoUrl !== undefined) tenants[idx].logoUrl = logoUrl;\n  if (hero !== undefined) tenants[idx].hero = normalizeHero(hero);\n  if (banners !== undefined) tenants[idx].banners = banners;\n  if (whatsappPhone !== undefined) {\n    const cleaned = typeof whatsappPhone === 'string' ? whatsappPhone.replace(/\\D/g, '') : '';\n    tenants[idx].whatsappPhone = cleaned || undefined;\n  }\n  const before = { ...tenants[idx] };\n  setTenants(tenants);\n  appendAuditEvent({\n    userId: user!.id,\n    role: user!.role,\n    marketId: t.marketId,\n    action: 'update',\n    entity: 'tenant',\n    entityId: id,\n    reason: user!.role === 'ROOT_ADMIN' ? getEmergencyReason(req) : undefined,\n    emergencyMode: user!.role === 'ROOT_ADMIN',\n    before,\n    after: tenants[idx],\n  });\n  res.json(normalizeTenantResponse(tenants[idx]));\n});\n\n// --- Upload ---\napp.post('/upload', (req, res, next) => {\n  upload.array('files', 20)(req, res, (err) => {\n    if (err) return res.status(400).json({ error: err.message });\n    const files = (req as { files?: Express.Multer.File[] }).files ?? [];\n    const base = `http://localhost:${PORT}`;\n    const urls = files.map((f) => `${base}/uploads/${f.filename}`);\n    res.json({ urls });\n  });\n});\n\n// --- Catalog ---\napp.get('/catalog/:tenantId', (req, res) => {\n  const catalog = getCatalog(req.params.tenantId);\n  res.json(catalog);\n});\n\nfunction normalizeProductForCompat(p: { imageUrl?: string; images?: { url: string }[] }) {\n  const images = p.images ?? [];\n  if (images.length > 0) {\n    return { ...p, imageUrl: images[0].url };\n  }\n  return p;\n}\n\napp.put('/catalog/:tenantId', (req, res) => {\n  const catalog = req.body as TenantCatalog;\n  const products = (catalog.products ?? []).map((p: { imageUrl?: string; images?: { url: string }[] }) =>\n    normalizeProductForCompat(p)\n  );\n  const normalized = { ...catalog, products };\n  setCatalog(req.params.tenantId, normalized);\n  res.json(getCatalog(req.params.tenantId));\n});\n\n// --- Orders ---\nfunction getMarketTenantIds(marketId: string): Set<string> {\n  return new Set(getTenants().filter((t) => t.marketId === marketId).map((t) => t.id));\n}\n\napp.get('/orders', (req, res) => {\n  const tenantId = req.query.tenantId as string | undefined;\n  let orders = getOrders() as { tenantId?: string }[];\n  if (req.user?.role === 'TENANT_ADMIN') {\n    const ownTenantId = req.user.tenantId;\n    if (!ownTenantId) return res.status(403).json({ error: 'Forbidden' });\n    if (tenantId && tenantId !== ownTenantId) return res.status(403).json({ error: 'Forbidden' });\n    orders = orders.filter((o) => o.tenantId === ownTenantId);\n  } else if (tenantId) {\n    orders = orders.filter((o) => o.tenantId === tenantId);\n  }\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId) {\n    const allowed = getMarketTenantIds(req.user.marketId);\n    orders = orders.filter((o) => o.tenantId && allowed.has(o.tenantId));\n  }\n  res.json(orders);\n});\n\n/** Tenant-scoped orders: TENANT_ADMIN own only; MARKET_ADMIN tenants in market; ROOT_ADMIN any */\napp.get('/tenants/:tenantId/orders', (req, res) => {\n  const { tenantId } = req.params;\n  const tenant = getTenants().find((t) => t.id === tenantId);\n  if (!tenant) return res.status(404).json({ error: 'Tenant not found' });\n  if (req.user?.role === 'TENANT_ADMIN' && req.user.tenantId !== tenantId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (req.user?.role === 'MARKET_ADMIN' && tenant.marketId !== req.user.marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  const orders = (getOrders() as { tenantId?: string }[]).filter((o) => o.tenantId === tenantId);\n  res.json(orders);\n});\n\napp.post('/orders', (req, res) => {\n  const order = req.body as {\n    tenantId?: string;\n    status?: string;\n    prepTimeMin?: number;\n    readyAt?: string;\n    deliveryAssignmentMode?: string;\n    fulfillmentType?: string;\n    createdAt?: string;\n    [key: string]: unknown;\n  };\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId) {\n    const tenant = getTenants().find((t) => t.id === order.tenantId);\n    if (!tenant || tenant.marketId !== req.user.marketId) {\n      return res.status(403).json({ error: 'Forbidden' });\n    }\n  }\n  const tenant = order.tenantId ? getTenants().find((t) => t.id === order.tenantId) : undefined;\n  const tenantType = tenant?.tenantType ?? (tenant?.type === 'FOOD' ? 'RESTAURANT' : 'SHOP');\n  const deliveryMode = tenant?.deliveryProviderMode ?? 'TENANT';\n\n  const now = new Date().toISOString();\n  const created = { ...order, createdAt: order.createdAt ?? now };\n  if (tenant?.marketId) (created as { marketId?: string }).marketId = tenant.marketId;\n\n  if (created.fulfillmentType === 'PICKUP' || deliveryMode === 'PICKUP_ONLY') {\n    created.status = created.status ?? 'PREPARING';\n    created.deliveryAssignmentMode = undefined;\n  } else {\n    created.deliveryAssignmentMode = deliveryMode === 'MARKET' ? 'MARKET' : 'TENANT';\n    if (tenantType === 'RESTAURANT') {\n      const prepMin = order.prepTimeMin ?? tenant?.defaultPrepTimeMin ?? 30;\n      created.status = 'PREPARING';\n      created.prepTimeMin = prepMin;\n      const readyDate = new Date(created.createdAt ?? now);\n      readyDate.setMinutes(readyDate.getMinutes() + prepMin);\n      created.readyAt = readyDate.toISOString();\n    } else {\n      created.status = created.status ?? 'PREPARING';\n      created.readyAt = created.createdAt ?? now;\n    }\n  }\n\n  const payment = computePaymentForOrder(created, created.tenantId ?? '');\n  (created as Record<string, unknown>).payment = {\n    ...payment,\n    method: ((created as { paymentMethod?: string }).paymentMethod === 'CARD' ? 'CARD' : 'CASH') as 'CASH' | 'CARD',\n  };\n\n  const orders = getOrders();\n  orders.push(created);\n  setOrders(orders);\n  res.status(201).json(created);\n});\n\napp.get('/orders/:orderId', (req, res) => {\n  const order = (getOrders() as { id?: string; tenantId?: string }[]).find((o) => o.id === req.params.orderId);\n  if (!order) return res.status(404).json({ error: 'Order not found' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId) {\n    const tenant = getTenants().find((t) => t.id === order.tenantId);\n    if (!tenant || tenant.marketId !== req.user.marketId) {\n      return res.status(403).json({ error: 'Forbidden' });\n    }\n  }\n  res.json(order);\n});\n\n/** Public order status: no auth. Returns safe fields for customer order confirmation. */\napp.get('/public/orders/:orderId', (req, res) => {\n  const order = (getOrders() as Record<string, unknown>[]).find((o) => o.id === req.params.orderId);\n  if (!order) return res.status(404).json({ error: 'Order not found' });\n  const tenant = (order.tenantId as string)\n    ? getTenants().find((t) => t.id === order.tenantId)\n    : undefined;\n  const safe: Record<string, unknown> = {\n    id: order.id,\n    status: order.status,\n    total: order.total,\n    currency: order.currency,\n    subtotal: order.subtotal,\n    items: order.items,\n    createdAt: order.createdAt,\n    fulfillmentType: order.fulfillmentType,\n    delivery: order.delivery,\n    deliveryAddress: order.deliveryAddress,\n    customerName: order.customerName,\n    customerPhone: order.customerPhone,\n    notes: order.notes,\n    tenantId: order.tenantId,\n    tenantSlug: tenant?.slug,\n  };\n  res.json(safe);\n});\n\napp.patch('/orders/:orderId/status', (req, res) => {\n  const { status } = req.body as { status: string };\n  const orders = getOrders() as { id?: string; status?: string; tenantId?: string; courierId?: string }[];\n  const idx = orders.findIndex((o) => o.id === req.params.orderId);\n  if (idx === -1) return res.status(404).json({ error: 'Order not found' });\n  const order = orders[idx];\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId) {\n    const tenant = getTenants().find((t) => t.id === order.tenantId);\n    if (!tenant || tenant.marketId !== req.user.marketId) {\n      return res.status(403).json({ error: 'Forbidden' });\n    }\n  }\n  const updated = { ...orders[idx], status };\n  if (status === 'DELIVERED' && order.courierId) {\n    updated.deliveredAt = new Date().toISOString();\n    const couriers = getCouriers();\n    const cIdx = couriers.findIndex((c) => c.id === order.courierId);\n    if (cIdx >= 0) {\n      couriers[cIdx] = {\n        ...couriers[cIdx],\n        isAvailable: true,\n        deliveryCount: (couriers[cIdx].deliveryCount ?? 0) + 1,\n      };\n      setCouriers(couriers);\n    }\n  }\n  orders[idx] = updated;\n  setOrders(orders);\n  res.json(orders[idx]);\n});\n\n// --- Campaigns ---\napp.get('/campaigns', (req, res) => {\n  const tenantId = req.query.tenantId as string | undefined;\n  let campaigns = getCampaigns() as { tenantId?: string }[];\n  if (tenantId) campaigns = campaigns.filter((c) => c.tenantId === tenantId);\n  res.json(campaigns);\n});\n\napp.post('/campaigns', (req, res) => {\n  const campaign = req.body;\n  const campaigns = getCampaigns();\n  campaigns.push(campaign);\n  setCampaigns(campaigns);\n  res.status(201).json(campaign);\n});\n\napp.put('/campaigns/:id', (req, res) => {\n  const campaigns = getCampaigns() as { id?: string }[];\n  const idx = campaigns.findIndex((c) => c.id === req.params.id);\n  if (idx === -1) return res.status(404).json({ error: 'Campaign not found' });\n  campaigns[idx] = { ...campaigns[idx], ...req.body };\n  setCampaigns(campaigns);\n  res.json(campaigns[idx]);\n});\n\napp.delete('/campaigns/:id', (req, res) => {\n  const campaigns = getCampaigns() as { id?: string }[];\n  const next = campaigns.filter((c) => c.id !== req.params.id);\n  if (next.length === campaigns.length) return res.status(404).json({ error: 'Campaign not found' });\n  setCampaigns(next);\n  res.json({ deleted: true });\n});\n\n// --- Delivery ---\napp.get('/delivery/:tenantId', (req, res) => {\n  const settings = getDelivery()[req.params.tenantId];\n  if (!settings) return res.status(404).json({ error: 'Delivery settings not found' });\n  res.json(settings);\n});\n\napp.put('/delivery/:tenantId', (req, res) => {\n  const delivery = getDelivery();\n  delivery[req.params.tenantId] = { ...req.body, tenantId: req.params.tenantId };\n  setDelivery(delivery);\n  res.json(delivery[req.params.tenantId]);\n});\n\n// --- Delivery Zones ---\nfunction sortZones(zones: DeliveryZoneRecord[]): DeliveryZoneRecord[] {\n  return [...zones].sort((a, b) => {\n    const soA = a.sortOrder ?? 999;\n    const soB = b.sortOrder ?? 999;\n    if (soA !== soB) return soA - soB;\n    return (a.name ?? '').localeCompare(b.name ?? '');\n  });\n}\n\napp.get('/tenants/:tenantId/delivery-zones', (req, res) => {\n  const zones = getDeliveryZones(req.params.tenantId);\n  res.json(sortZones(zones));\n});\n\napp.post('/tenants/:tenantId/delivery-zones', (req, res) => {\n  const { tenantId } = req.params;\n  const body = req.body as Omit<DeliveryZoneRecord, 'id' | 'tenantId'>;\n  const id = crypto.randomUUID?.() ?? `dz-${Date.now()}`;\n  const zone: DeliveryZoneRecord = {\n    id,\n    tenantId,\n    name: body.name ?? '',\n    fee: body.fee ?? 0,\n    etaMinutes: body.etaMinutes,\n    isActive: body.isActive ?? true,\n    sortOrder: body.sortOrder,\n  };\n  const zones = getDeliveryZones(tenantId);\n  zones.push(zone);\n  setDeliveryZones(tenantId, zones);\n  res.status(201).json(zone);\n});\n\napp.put('/tenants/:tenantId/delivery-zones/:zoneId', (req, res) => {\n  const { tenantId, zoneId } = req.params;\n  const body = req.body as Partial<Omit<DeliveryZoneRecord, 'id' | 'tenantId'>>;\n  const zones = getDeliveryZones(tenantId);\n  const idx = zones.findIndex((z) => z.id === zoneId);\n  if (idx === -1) return res.status(404).json({ error: 'Zone not found' });\n  zones[idx] = { ...zones[idx], ...body };\n  setDeliveryZones(tenantId, zones);\n  res.json(zones[idx]);\n});\n\napp.patch('/tenants/:tenantId/delivery-zones/:zoneId', (req, res) => {\n  const { tenantId, zoneId } = req.params;\n  const body = req.body as Partial<Pick<DeliveryZoneRecord, 'isActive' | 'name' | 'fee' | 'etaMinutes' | 'sortOrder'>>;\n  const zones = getDeliveryZones(tenantId);\n  const idx = zones.findIndex((z) => z.id === zoneId);\n  if (idx === -1) return res.status(404).json({ error: 'Zone not found' });\n  zones[idx] = { ...zones[idx], ...body };\n  setDeliveryZones(tenantId, zones);\n  res.json(zones[idx]);\n});\n\napp.delete('/tenants/:tenantId/delivery-zones/:zoneId', (req, res) => {\n  const { tenantId, zoneId } = req.params;\n  const zones = getDeliveryZones(tenantId).filter((z) => z.id !== zoneId);\n  if (zones.length === getDeliveryZones(tenantId).length) return res.status(404).json({ error: 'Zone not found' });\n  setDeliveryZones(tenantId, zones);\n  res.json({ deleted: true });\n});\n\n// --- Tenant delivery settings (PATCH) ---\napp.patch('/tenants/:tenantId/settings/delivery', (req, res) => {\n  const { tenantId } = req.params;\n  const user = req.user;\n  const tenants = getTenants();\n  const tenant = tenants.find((t) => t.id === tenantId);\n  if (!tenant) return res.status(404).json({ error: 'Tenant not found' });\n\n  if (user?.role === 'TENANT_ADMIN' && user.tenantId !== tenantId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== tenant.marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const body = req.body as { tenantType?: string; deliveryProviderMode?: string; allowMarketCourierFallback?: boolean; defaultPrepTimeMin?: number };\n  const updates: Partial<RegistryTenant> = {};\n  if (body.tenantType !== undefined) updates.tenantType = body.tenantType as 'RESTAURANT' | 'SHOP' | 'SERVICE';\n  if (body.deliveryProviderMode !== undefined) updates.deliveryProviderMode = body.deliveryProviderMode as 'TENANT' | 'MARKET' | 'PICKUP_ONLY';\n  if (body.allowMarketCourierFallback !== undefined) updates.allowMarketCourierFallback = body.allowMarketCourierFallback;\n  if (body.defaultPrepTimeMin !== undefined) updates.defaultPrepTimeMin = body.defaultPrepTimeMin;\n\n  const idx = tenants.findIndex((t) => t.id === tenantId);\n  const before = { ...tenants[idx] };\n  tenants[idx] = { ...tenants[idx], ...updates };\n  setTenants(tenants);\n  appendAuditEvent({\n    userId: user!.id,\n    role: user!.role,\n    marketId: tenant.marketId,\n    action: 'update',\n    entity: 'tenant',\n    entityId: tenantId,\n    reason: user!.role === 'ROOT_ADMIN' ? getEmergencyReason(req) : undefined,\n    emergencyMode: user!.role === 'ROOT_ADMIN',\n    before,\n    after: tenants[idx],\n  });\n  res.json(tenants[idx]);\n});\n\n// --- Mark order READY (restaurant) ---\napp.post('/tenants/:tenantId/orders/:orderId/ready', (req, res) => {\n  const { tenantId, orderId } = req.params;\n  const user = req.user;\n  const tenant = getTenants().find((t) => t.id === tenantId);\n  if (!tenant) return res.status(404).json({ error: 'Tenant not found' });\n\n  if (user?.role === 'TENANT_ADMIN' && user.tenantId !== tenantId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== tenant.marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const orders = getOrders() as { id?: string; tenantId?: string }[];\n  const idx = orders.findIndex((o) => o.id === orderId);\n  if (idx === -1) return res.status(404).json({ error: 'Order not found' });\n  if (orders[idx].tenantId !== tenantId) return res.status(403).json({ error: 'Forbidden' });\n\n  const now = new Date().toISOString();\n  orders[idx] = { ...orders[idx], status: 'READY', readyAt: now };\n  setOrders(orders);\n  res.json(orders[idx]);\n});\n\n/** Helper: courier's market ID (for MARKET-scoped couriers) */\nfunction courierMarketId(c: { scopeType?: string; scopeId?: string; marketId?: string }): string | undefined {\n  if (c.scopeType !== 'MARKET') return undefined;\n  return c.marketId ?? c.scopeId;\n}\n\n/** SLA threshold (minutes) for onTimeRate: delivery within this = on time */\nconst SLA_OK_MIN = 30;\n\n/** Pure gamification: input = delivered orders in period, output = points, badges, rankScore. Uses UTC boundaries. */\nfunction computeGamification(\n  orders: { deliveryTimeline?: { deliveredAt?: string; durations?: { totalMinutes?: number } } }[],\n  period: 'day' | 'week'\n): { points: number; badges: string[]; rankScore: number } {\n  const now = new Date();\n  const todayStart = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());\n  const weekStart = todayStart - 7 * 24 * 60 * 60 * 1000;\n  const cutoff = period === 'day' ? todayStart : weekStart;\n  const filtered = orders.filter((o) => {\n    const at = o.deliveryTimeline?.deliveredAt;\n    if (!at) return false;\n    return new Date(at).getTime() >= cutoff;\n  });\n\n  let points = 0;\n  const badges: string[] = [];\n\n  for (const o of filtered) {\n    points += 10;\n    const totalMin = o.deliveryTimeline?.durations?.totalMinutes;\n    if (totalMin != null && totalMin < SLA_OK_MIN) points += 5;\n  }\n\n  const onTimeCount = filtered.filter((o) => {\n    const m = o.deliveryTimeline?.durations?.totalMinutes;\n    return m != null && m < SLA_OK_MIN;\n  }).length;\n  const count = filtered.length;\n  const allOnTime = count > 0 && onTimeCount === count;\n\n  if (period === 'day') {\n    if (count >= 3 && allOnTime) badges.push('سريع');\n  } else {\n    if (count >= 5) badges.push('بطل الأسبوع');\n    if (count >= 5 && allOnTime) badges.push('دقيق');\n    if (count >= 10) badges.push('مثابر');\n  }\n\n  return { points, badges, rankScore: points };\n}\n\ntype DeliveredOrderForMetrics = {\n  deliveryTimeline?: { deliveredAt?: string; durations?: { totalMinutes?: number; pickedUpToDelivered?: number } };\n};\n\n/** Compute courier performance metrics + gamification from delivered orders in market. UTC boundaries. */\nfunction computeCourierMetrics(marketId: string, courierId: string): {\n  deliveredCountToday: number;\n  deliveredCountWeek: number;\n  avgTotalMin: number | null;\n  avgPickupToDeliveredMin: number | null;\n  onTimeRate: number | null;\n  pointsToday: number;\n  pointsWeek: number;\n  badgesWeek: string[];\n} {\n  const tenantIds = getMarketTenantIds(marketId);\n  const orders = (getOrders() as (DeliveredOrderForMetrics & { tenantId?: string; courierId?: string; status?: string; fulfillmentType?: string })[]).filter(\n    (o) =>\n      o.fulfillmentType === 'DELIVERY' &&\n      o.courierId === courierId &&\n      o.status === 'DELIVERED' &&\n      o.tenantId &&\n      tenantIds.has(o.tenantId)\n  );\n  const withDeliveredAt = orders.filter((o) => o.deliveryTimeline?.deliveredAt) as DeliveredOrderForMetrics[];\n  const now = new Date();\n  const todayStart = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());\n  const weekStart = todayStart - 7 * 24 * 60 * 60 * 1000;\n  let deliveredCountToday = 0;\n  let deliveredCountWeek = 0;\n  const totalMins: number[] = [];\n  const pickupMins: number[] = [];\n  let onTimeCount = 0;\n  let withDurationCount = 0;\n  for (const o of withDeliveredAt) {\n    const t = new Date(o.deliveryTimeline!.deliveredAt!).getTime();\n    if (t >= todayStart) deliveredCountToday++;\n    if (t >= weekStart) deliveredCountWeek++;\n    const dur = o.deliveryTimeline?.durations;\n    if (dur?.totalMinutes != null) {\n      totalMins.push(dur.totalMinutes);\n      withDurationCount++;\n      if (dur.totalMinutes < SLA_OK_MIN) onTimeCount++;\n    }\n    if (dur?.pickedUpToDelivered != null) pickupMins.push(dur.pickedUpToDelivered);\n  }\n  const gamificationDay = computeGamification(withDeliveredAt, 'day');\n  const gamificationWeek = computeGamification(withDeliveredAt, 'week');\n  return {\n    deliveredCountToday,\n    deliveredCountWeek,\n    avgTotalMin: totalMins.length ? Math.round(totalMins.reduce((a, b) => a + b, 0) / totalMins.length) : null,\n    avgPickupToDeliveredMin: pickupMins.length ? Math.round(pickupMins.reduce((a, b) => a + b, 0) / pickupMins.length) : null,\n    onTimeRate: withDurationCount > 0 ? Math.round((onTimeCount / withDurationCount) * 100) : null,\n    pointsToday: gamificationDay.points,\n    pointsWeek: gamificationWeek.points,\n    badgesWeek: gamificationWeek.badges,\n  };\n}\n\n// --- Market couriers ---\napp.get('/markets/:marketId/couriers', (req, res) => {\n  const { marketId } = req.params;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden', code: 'SCOPE_VIOLATION' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Cannot access couriers from another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  const couriers = getCouriers().filter((c) => courierMarketId(c) === marketId);\n  res.json(couriers);\n});\n\n/** Courier performance stats. MARKET_ADMIN scoped. Same access rules as GET /couriers. */\napp.get('/markets/:marketId/couriers/stats', (req, res) => {\n  const { marketId } = req.params;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden', code: 'SCOPE_VIOLATION' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Cannot access couriers from another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  const couriers = getCouriers().filter((c) => courierMarketId(c) === marketId);\n  const list = couriers.map((c) => ({\n    ...c,\n    ...computeCourierMetrics(marketId, c.id),\n  }));\n  res.json(list);\n});\n\n/** Weekly leaderboard. MARKET_ADMIN: own market; COURIER: own market only; TENANT_ADMIN: 403. */\napp.get('/markets/:marketId/leaderboard', (req, res) => {\n  const { marketId } = req.params;\n  const period = (req.query.period as string) || 'week';\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden', code: 'SCOPE_VIOLATION' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Cannot access leaderboard from another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (req.user?.role === 'COURIER' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Courier can only access own market leaderboard', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (period !== 'week') return res.status(400).json({ error: 'period=week only' });\n\n  const couriers = getCouriers().filter((c) => courierMarketId(c) === marketId);\n  const withMetrics = couriers.map((c) => ({\n    courierId: c.id,\n    name: c.name,\n    ...computeCourierMetrics(marketId, c.id),\n  }));\n  withMetrics.sort((a, b) => {\n    const pa = a.pointsWeek ?? 0;\n    const pb = b.pointsWeek ?? 0;\n    if (pa !== pb) return pb - pa;\n    const oa = a.onTimeRate ?? -1;\n    const ob = b.onTimeRate ?? -1;\n    if (oa !== ob) return ob - oa;\n    const ma = a.avgTotalMin ?? 9999;\n    const mb = b.avgTotalMin ?? 9999;\n    return ma - mb;\n  });\n  const leaderboard = withMetrics.map((row, i) => ({\n    courierId: row.courierId,\n    name: row.name,\n    pointsWeek: row.pointsWeek ?? 0,\n    badgesWeek: row.badgesWeek ?? [],\n    avgTotalMin: row.avgTotalMin,\n    onTimeRate: row.onTimeRate,\n    rank: i + 1,\n  }));\n  const myCourierId = req.user?.role === 'COURIER' ? req.user.courierId : undefined;\n  const myRow = myCourierId ? leaderboard.find((r) => r.courierId === myCourierId) : undefined;\n  res.json({\n    leaderboard,\n    myRank: myRow?.rank ?? null,\n  });\n});\n\napp.post('/markets/:marketId/couriers', (req, res) => {\n  const { marketId } = req.params;\n  const user = req.user;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden', code: 'SCOPE_VIOLATION' });\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Cannot create couriers in another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const body = req.body as { name?: string; phone?: string };\n  const id = `courier-${crypto.randomUUID?.() ?? Date.now()}`;\n  const courier: Courier = {\n    id,\n    scopeType: 'MARKET',\n    scopeId: marketId,\n    marketId,\n    name: body.name ?? '',\n    phone: body.phone,\n    isActive: true,\n    isOnline: false,\n    capacity: 3,\n    isAvailable: true,\n    deliveryCount: 0,\n  };\n  const couriers = getCouriers();\n  couriers.push(courier);\n  setCouriers(couriers);\n  appendAuditEvent({\n    userId: user!.id,\n    role: user!.role,\n    marketId,\n    action: 'create',\n    entity: 'courier',\n    entityId: id,\n    reason: user!.role === 'ROOT_ADMIN' ? getEmergencyReason(req) : undefined,\n    emergencyMode: user!.role === 'ROOT_ADMIN',\n    after: courier,\n  });\n  res.status(201).json(courier);\n});\n\napp.patch('/markets/:marketId/couriers/:courierId', (req, res) => {\n  const { marketId, courierId } = req.params;\n  const user = req.user;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden', code: 'SCOPE_VIOLATION' });\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Cannot update couriers in another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const couriers = getCouriers();\n  const idx = couriers.findIndex((c) => c.id === courierId && courierMarketId(c) === marketId);\n  if (idx === -1) {\n    const other = couriers.find((c) => c.id === courierId);\n    if (other && courierMarketId(other) && courierMarketId(other) !== marketId) {\n      return res.status(403).json({ error: 'Courier belongs to another market', code: 'CROSS_MARKET_ACCESS' });\n    }\n    return res.status(404).json({ error: 'Courier not found' });\n  }\n  const before = { ...couriers[idx] };\n  const body = req.body as Partial<Pick<Courier, 'name' | 'phone' | 'isActive' | 'isOnline' | 'isAvailable' | 'capacity'>>;\n  couriers[idx] = { ...couriers[idx], ...body };\n  setCouriers(couriers);\n  appendAuditEvent({\n    userId: user!.id,\n    role: user!.role,\n    marketId,\n    action: 'update',\n    entity: 'courier',\n    entityId: courierId,\n    reason: user!.role === 'ROOT_ADMIN' ? getEmergencyReason(req) : undefined,\n    emergencyMode: user!.role === 'ROOT_ADMIN',\n    before,\n    after: couriers[idx],\n  });\n  res.json(couriers[idx]);\n});\n\napp.delete('/markets/:marketId/couriers/:courierId', (req, res) => {\n  const { marketId, courierId } = req.params;\n  const user = req.user;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden', code: 'SCOPE_VIOLATION' });\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Cannot delete couriers in another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const couriers = getCouriers();\n  const idx = couriers.findIndex((c) => c.id === courierId && courierMarketId(c) === marketId);\n  if (idx === -1) {\n    const other = couriers.find((c) => c.id === courierId);\n    if (other && courierMarketId(other) && courierMarketId(other) !== marketId) {\n      return res.status(403).json({ error: 'Courier belongs to another market', code: 'CROSS_MARKET_ACCESS' });\n    }\n    return res.status(404).json({ error: 'Courier not found' });\n  }\n  const before = { ...couriers[idx] };\n  couriers[idx] = { ...couriers[idx], isActive: false };\n  setCouriers(couriers);\n  appendAuditEvent({\n    userId: user!.id,\n    role: user!.role,\n    marketId,\n    action: 'update',\n    entity: 'courier',\n    entityId: courierId,\n    reason: user!.role === 'ROOT_ADMIN' ? getEmergencyReason(req) : 'soft-delete',\n    emergencyMode: user!.role === 'ROOT_ADMIN',\n    before,\n    after: couriers[idx],\n  });\n  res.json(couriers[idx]);\n});\n\n// --- Tenant couriers ---\napp.get('/tenants/:tenantId/couriers', (req, res) => {\n  const { tenantId } = req.params;\n  const tenant = getTenants().find((t) => t.id === tenantId);\n  if (!tenant) return res.status(404).json({ error: 'Tenant not found' });\n  if (req.user?.role === 'TENANT_ADMIN' && req.user.tenantId !== tenantId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== tenant.marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  const couriers = getCouriers().filter((c) => c.scopeType === 'TENANT' && c.scopeId === tenantId);\n  res.json(couriers);\n});\n\napp.post('/tenants/:tenantId/couriers', (req, res) => {\n  const { tenantId } = req.params;\n  const user = req.user;\n  const tenant = getTenants().find((t) => t.id === tenantId);\n  if (!tenant) return res.status(404).json({ error: 'Tenant not found' });\n  if (user?.role === 'TENANT_ADMIN' && user.tenantId !== tenantId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== tenant.marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const body = req.body as { name?: string; phone?: string };\n  const id = `courier-${crypto.randomUUID?.() ?? Date.now()}`;\n  const courier: Courier = {\n    id,\n    scopeType: 'TENANT',\n    scopeId: tenantId,\n    name: body.name ?? '',\n    phone: body.phone,\n    isActive: true,\n    isOnline: false,\n    capacity: 3,\n  };\n  const couriers = getCouriers();\n  couriers.push(courier);\n  setCouriers(couriers);\n  res.status(201).json(courier);\n});\n\napp.patch('/tenants/:tenantId/couriers/:courierId', (req, res) => {\n  const { tenantId, courierId } = req.params;\n  const user = req.user;\n  const tenant = getTenants().find((t) => t.id === tenantId);\n  if (!tenant) return res.status(404).json({ error: 'Tenant not found' });\n  if (user?.role === 'TENANT_ADMIN' && user.tenantId !== tenantId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== tenant.marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const couriers = getCouriers();\n  const idx = couriers.findIndex((c) => c.id === courierId && c.scopeType === 'TENANT' && c.scopeId === tenantId);\n  if (idx === -1) return res.status(404).json({ error: 'Courier not found' });\n  const body = req.body as Partial<Pick<Courier, 'name' | 'phone' | 'isActive' | 'isOnline' | 'capacity'>>;\n  couriers[idx] = { ...couriers[idx], ...body };\n  setCouriers(couriers);\n  res.json(couriers[idx]);\n});\n\n/** Market orders: all orders from tenants in this market. Requires MARKET_ADMIN or ROOT_ADMIN. */\napp.get('/markets/:marketId/orders', (req, res) => {\n  const { marketId } = req.params;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  const tenantIds = getMarketTenantIds(marketId);\n  const orders = (getOrders() as { tenantId?: string }[]).filter(\n    (o) => o.tenantId && tenantIds.has(o.tenantId)\n  );\n  res.json(orders);\n});\n\ntype OrderWithPayment = {\n  id?: string;\n  tenantId?: string;\n  courierId?: string;\n  status?: string;\n  fulfillmentType?: string;\n  deliveryStatus?: string;\n  createdAt?: string;\n  total?: number;\n  subtotal?: number;\n  delivery?: { fee?: number };\n  payment?: {\n    method?: string;\n    status?: string;\n    breakdown?: { itemsTotal?: number; deliveryFee?: number };\n    financials?: { gross?: number; commission?: number; netToMerchant?: number; netToMarket?: number };\n    cashLedger?: { collected?: boolean };\n  };\n  paymentMethod?: string;\n};\n\nfunction ordersInDateRange(orders: OrderWithPayment[], from?: string, to?: string): OrderWithPayment[] {\n  if (!from && !to) return orders;\n  const fromMs = from ? new Date(from).setHours(0, 0, 0, 0) : 0;\n  const toMs = to ? new Date(to).setHours(23, 59, 59, 999) : Number.MAX_SAFE_INTEGER;\n  return orders.filter((o) => {\n    const t = o.createdAt ? new Date(o.createdAt).getTime() : 0;\n    return t >= fromMs && t <= toMs;\n  });\n}\n\n/** Safely compute financial values from order. Handles legacy orders missing payment fields. Never throws. */\nfunction computeOrderFinancials(o: OrderWithPayment | null | undefined): {\n  gross: number;\n  itemsTotal: number;\n  deliveryFee: number;\n  commission: number;\n  netToMerchant: number;\n  isCash: boolean;\n  isCashCollected: boolean;\n} {\n  if (!o) return { gross: 0, itemsTotal: 0, deliveryFee: 0, commission: 0, netToMerchant: 0, isCash: true, isCashCollected: false };\n  const pay = o.payment;\n  const safeNum = (v: unknown): number => (typeof v === 'number' && !Number.isNaN(v) ? v : 0);\n  const items = Array.isArray(o?.items) ? o.items : [];\n  const itemsSum = items.reduce((s, i) => s + safeNum(i?.totalPrice), 0);\n  const subtotal = safeNum(o?.subtotal) || itemsSum;\n  const total = safeNum(o?.total) || (subtotal + safeNum(o?.delivery?.fee));\n  const deliveryFee = safeNum(pay?.breakdown?.deliveryFee) || safeNum(o?.delivery?.fee);\n\n  const gross = safeNum(pay?.financials?.gross) || total;\n  const itemsTotal = safeNum(pay?.breakdown?.itemsTotal) || subtotal;\n  const commission = safeNum(pay?.financials?.commission);\n  const netToMerchant = safeNum(pay?.financials?.netToMerchant);\n\n  const method = pay?.method ?? o?.paymentMethod;\n  const isCash = method === 'CASH' || method === undefined || method === null;\n  const isCashCollected = Boolean(pay?.cashLedger?.collected);\n\n  return { gross, itemsTotal, deliveryFee, commission, netToMerchant, isCash, isCashCollected };\n}\n\n/** Market finance summary. MARKET_ADMIN: own market; ROOT_ADMIN: read-only. */\napp.get('/markets/:marketId/finance/summary', (req, res) => {\n  const { marketId } = req.params;\n  const from = req.query.from as string | undefined;\n  const to = req.query.to as string | undefined;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  const tenantIds = getMarketTenantIds(marketId);\n  const allOrders = (getOrders() as OrderWithPayment[]).filter(\n    (o) => o.tenantId && tenantIds.has(o.tenantId)\n  );\n  const orders = ordersInDateRange(allOrders, from, to);\n\n  let gross = 0;\n  let itemsTotal = 0;\n  let deliveryFees = 0;\n  let commission = 0;\n  let netToMerchants = 0;\n  let cashCollected = 0;\n  let outstandingCash = 0;\n  let totalOrders = orders.length;\n  let deliveredOrders = 0;\n  let activeDeliveryOrders = 0;\n  let cashOrders = 0;\n\n  for (const o of orders) {\n    const f = computeOrderFinancials(o);\n    if (f.isCash) cashOrders++;\n    const isDelivered = o.status === 'DELIVERED' || o.status === 'COMPLETED';\n    if (isDelivered) deliveredOrders++;\n    const isActiveDelivery = o.fulfillmentType === 'DELIVERY' && !['DELIVERED', 'COMPLETED', 'CANCELED'].includes(o.status ?? '');\n    if (isActiveDelivery) activeDeliveryOrders++;\n\n    gross += f.gross;\n    itemsTotal += f.itemsTotal;\n    deliveryFees += f.deliveryFee;\n    commission += f.commission;\n    netToMerchants += f.netToMerchant;\n    if (f.isCash) {\n      if (f.isCashCollected) cashCollected += f.gross;\n      else if (isDelivered) outstandingCash += f.gross;\n    }\n  }\n\n  res.json({\n    gross,\n    itemsTotal,\n    deliveryFees,\n    commission,\n    netToMerchants,\n    cashCollected,\n    outstandingCash,\n    totalOrders,\n    deliveredOrders,\n    activeDeliveryOrders,\n    cashOrders,\n  });\n});\n\n/** Market finance by tenant. MARKET_ADMIN: own market; ROOT_ADMIN: read-only. */\napp.get('/markets/:marketId/finance/tenants', (req, res) => {\n  const { marketId } = req.params;\n  const from = req.query.from as string | undefined;\n  const to = req.query.to as string | undefined;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  const tenantIds = getMarketTenantIds(marketId);\n  const allOrders = (getOrders() as OrderWithPayment[]).filter(\n    (o) => o.tenantId && tenantIds.has(o.tenantId)\n  );\n  const orders = ordersInDateRange(allOrders, from, to);\n  const tenants = getTenants();\n\n  const byTenant = new Map<string, { gross: number; itemsTotal: number; deliveryFees: number; commission: number; netToMerchant: number; orderCount: number; deliveredCount: number }>();\n\n  for (const o of orders) {\n    const tid = o.tenantId ?? '';\n    if (!tid) continue;\n    let row = byTenant.get(tid);\n    if (!row) {\n      row = { gross: 0, itemsTotal: 0, deliveryFees: 0, commission: 0, netToMerchant: 0, orderCount: 0, deliveredCount: 0 };\n      byTenant.set(tid, row);\n    }\n    row.orderCount++;\n    const isDelivered = o.status === 'DELIVERED' || o.status === 'COMPLETED';\n    if (isDelivered) row.deliveredCount++;\n\n    const f = computeOrderFinancials(o);\n    row.gross += f.gross;\n    row.itemsTotal += f.itemsTotal;\n    row.deliveryFees += f.deliveryFee;\n    row.commission += f.commission;\n    row.netToMerchant += f.netToMerchant;\n  }\n\n  const result = Array.from(byTenant.entries()).map(([tenantId, row]) => {\n    const t = tenants.find((x) => x.id === tenantId);\n    return {\n      tenantId,\n      tenantName: t?.name ?? tenantId,\n      ...row,\n    };\n  });\n  res.json(result);\n});\n\n/** Market finance by courier. deliveredCount, cashCollectedGross, outstandingGross. MARKET_ADMIN: own market; ROOT_ADMIN: read-only. */\napp.get('/markets/:marketId/finance/couriers', (req, res) => {\n  const { marketId } = req.params;\n  const from = req.query.from as string | undefined;\n  const to = req.query.to as string | undefined;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  const tenantIds = getMarketTenantIds(marketId);\n  const allOrders = (getOrders() as OrderWithPayment[]).filter(\n    (o) => o.tenantId && tenantIds.has(o.tenantId) && o.courierId\n  );\n  const orders = ordersInDateRange(allOrders, from, to);\n  const couriers = getCouriers().filter((c) => courierMarketId(c) === marketId);\n\n  const ACTIVE_STATUSES = new Set(['ASSIGNED', 'IN_PROGRESS', 'PICKED_UP']);\n  const byCourier = new Map<string, { deliveredCount: number; cashCollectedGross: number; outstandingGross: number; activeUncollectedGross: number }>();\n\n  for (const o of orders) {\n    const cid = o.courierId ?? '';\n    if (!cid) continue;\n    let row = byCourier.get(cid);\n    if (!row) {\n      row = { deliveredCount: 0, cashCollectedGross: 0, outstandingGross: 0, activeUncollectedGross: 0 };\n      byCourier.set(cid, row);\n    }\n    const f = computeOrderFinancials(o);\n    const isDelivered = o.status === 'DELIVERED' || o.status === 'COMPLETED';\n    const deliveryStatus = o.deliveryStatus ?? '';\n    if (isDelivered) row.deliveredCount++;\n    if (f.isCash) {\n      if (f.isCashCollected) row.cashCollectedGross += f.gross;\n      else if (isDelivered) row.outstandingGross += f.gross;\n      else if (ACTIVE_STATUSES.has(deliveryStatus)) row.activeUncollectedGross += f.gross;\n    }\n  }\n\n  const result = couriers.map((c) => {\n    const row = byCourier.get(c.id) ?? { deliveredCount: 0, cashCollectedGross: 0, outstandingGross: 0, activeUncollectedGross: 0 };\n    return {\n      courierId: c.id,\n      courierName: c.name ?? c.id,\n      ...row,\n    };\n  });\n  res.json(result);\n});\n\n/** Assign courier to a MARKET delivery order. Validates courier.marketId == order.marketId == token.marketId. */\napp.post('/markets/:marketId/orders/:orderId/assign-courier', (req, res) => {\n  const { marketId, orderId } = req.params;\n  const user = req.user;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Cannot assign couriers in another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const body = req.body as { courierId?: string; reassign?: boolean };\n  const courierId = body.courierId;\n  if (!courierId || typeof courierId !== 'string') {\n    return res.status(400).json({ error: 'courierId is required' });\n  }\n\n  const orders = getOrders() as { id?: string; tenantId?: string; marketId?: string; deliveryAssignmentMode?: string; courierId?: string; deliveryStatus?: string }[];\n  const idx = orders.findIndex((o) => o.id === orderId);\n  if (idx === -1) return res.status(404).json({ error: 'Order not found' });\n  const order = orders[idx];\n\n  const orderMarketId = order.marketId ?? getTenants().find((t) => t.id === order.tenantId)?.marketId;\n  if (orderMarketId !== marketId) {\n    return res.status(403).json({ error: 'Order not in this market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (order.deliveryAssignmentMode !== 'MARKET') {\n    return res.status(400).json({ error: 'Order must have deliveryAssignmentMode MARKET' });\n  }\n\n  const currentStatus = order.deliveryStatus ?? (order.courierId ? 'ASSIGNED' : 'UNASSIGNED');\n  if (currentStatus !== 'UNASSIGNED' && !body.reassign) {\n    return res.status(409).json({ error: 'Order already assigned. Use reassign: true to change courier.', code: 'CONCURRENCY_CONFLICT' });\n  }\n\n  const couriers = getCouriers();\n  const courier = couriers.find((c) => c.id === courierId);\n  if (!courier) return res.status(404).json({ error: 'Courier not found' });\n  const cMarketId = courierMarketId(courier);\n  if (cMarketId !== marketId) {\n    return res.status(403).json({ error: 'Courier belongs to another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (!courier.isActive || !courier.isOnline) {\n    return res.status(400).json({ error: 'Courier must be active and online' });\n  }\n  if (courier.isAvailable === false) {\n    return res.status(400).json({ error: 'Courier is busy with another delivery' });\n  }\n\n  const before = { ...order };\n  const now = new Date().toISOString();\n  const timeline = (order as { deliveryTimeline?: { assignedAt?: string } }).deliveryTimeline ?? {};\n  const assignedAt = timeline.assignedAt ?? now;\n  orders[idx] = {\n    ...order,\n    courierId,\n    deliveryStatus: 'ASSIGNED',\n    deliveryTimeline: { ...timeline, assignedAt },\n  };\n  setOrders(orders);\n\n  const courierIdx = couriers.findIndex((c) => c.id === courierId);\n  if (courierIdx >= 0) {\n    couriers[courierIdx] = { ...couriers[courierIdx], isAvailable: false };\n    setCouriers(couriers);\n  }\n\n  appendAuditEvent({\n    id: `audit-${Date.now()}`,\n    at: new Date().toISOString(),\n    userId: user!.id,\n    role: user!.role,\n    marketId,\n    action: 'update',\n    entity: 'order',\n    entityId: orderId,\n    reason: `assign-courier ${courierId}`,\n    before: { courierId: before.courierId, deliveryStatus: before.deliveryStatus },\n    after: { courierId, deliveryStatus: 'ASSIGNED' },\n  });\n\n  emitCourierAssigned(courierId, orders[idx]);\n\n  res.json(orders[idx]);\n});\n\n/** Log contact for an order. Updates contactLog.lastContactedAt, channel, notes. */\napp.post('/markets/:marketId/orders/:orderId/contact', (req, res) => {\n  const { marketId, orderId } = req.params;\n  const user = req.user;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden', code: 'SCOPE_VIOLATION' });\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Order not in this market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const body = req.body as { channel?: string; notes?: string; message?: string };\n  const notes = body.notes?.trim() || body.message?.trim() || undefined;\n  const channel = body.channel?.trim() || undefined;\n  const orders = getOrders() as { id?: string; tenantId?: string; marketId?: string; contactLog?: { lastContactedAt?: string; channel?: string; notes?: string; entries?: { at: string; channel?: string; notes?: string; userId?: string }[] } }[];\n  const idx = orders.findIndex((o) => o.id === orderId);\n  if (idx === -1) return res.status(404).json({ error: 'Order not found' });\n  const order = orders[idx];\n  const orderMarketId = order.marketId ?? getTenants().find((t) => t.id === order.tenantId)?.marketId;\n  if (orderMarketId !== marketId) return res.status(403).json({ error: 'Order not in this market', code: 'CROSS_MARKET_ACCESS' });\n\n  const now = new Date().toISOString();\n  const contactLog = order.contactLog ?? {};\n  const entries = contactLog.entries ?? [];\n  entries.push({\n    at: now,\n    channel,\n    notes,\n    userId: user?.id,\n  });\n  orders[idx] = {\n    ...order,\n    contactLog: {\n      ...contactLog,\n      lastContactedAt: now,\n      channel,\n      notes,\n      entries,\n    },\n  };\n  setOrders(orders);\n  res.json(orders[idx]);\n});\n\n/** Unassign courier from a MARKET delivery order. */\napp.delete('/markets/:marketId/orders/:orderId/assign-courier', (req, res) => {\n  const { marketId, orderId } = req.params;\n  const user = req.user;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Cannot unassign in another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const orders = getOrders() as { id?: string; tenantId?: string; marketId?: string; deliveryAssignmentMode?: string; courierId?: string; deliveryStatus?: string }[];\n  const idx = orders.findIndex((o) => o.id === orderId);\n  if (idx === -1) return res.status(404).json({ error: 'Order not found' });\n  const order = orders[idx];\n\n  const orderMarketId = order.marketId ?? getTenants().find((t) => t.id === order.tenantId)?.marketId;\n  if (orderMarketId !== marketId) {\n    return res.status(403).json({ error: 'Order not in this market', code: 'CROSS_MARKET_ACCESS' });\n  }\n\n  const courierId = order.courierId;\n  const before = { ...order };\n  orders[idx] = { ...order, courierId: undefined, deliveryStatus: 'UNASSIGNED' };\n  setOrders(orders);\n\n  if (courierId) {\n    emitCourierUnassigned(courierId, orderId);\n    const otherAssigned = orders.filter(\n      (o) => o.courierId === courierId && o.id !== orderId && o.status !== 'DELIVERED' && o.status !== 'CANCELED'\n    );\n    if (otherAssigned.length === 0) {\n      const couriers = getCouriers();\n      const cIdx = couriers.findIndex((c) => c.id === courierId);\n      if (cIdx >= 0) {\n        couriers[cIdx] = { ...couriers[cIdx], isAvailable: true };\n        setCouriers(couriers);\n      }\n    }\n  }\n\n  appendAuditEvent({\n    id: `audit-${Date.now()}`,\n    at: new Date().toISOString(),\n    userId: user!.id,\n    role: user!.role,\n    marketId,\n    action: 'update',\n    entity: 'order',\n    entityId: orderId,\n    reason: 'unassign-courier',\n    before: { courierId: before.courierId, deliveryStatus: before.deliveryStatus },\n    after: { courierId: undefined, deliveryStatus: undefined },\n  });\n\n  res.json(orders[idx]);\n});\n\n// --- Market dispatch queue ---\napp.get('/markets/:marketId/dispatch/queue', (req, res) => {\n  const { marketId } = req.params;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  const queue = getDispatchQueue(marketId);\n  res.json(queue);\n});\n\n// --- Market delivery jobs ---\napp.get('/markets/:marketId/delivery-jobs', (req, res) => {\n  const { marketId } = req.params;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (req.user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  if (req.user?.role === 'MARKET_ADMIN' && req.user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  const jobs = getDeliveryJobs().filter((j) => j.marketId === marketId);\n  res.json(jobs);\n});\n\napp.post('/markets/:marketId/delivery-jobs', (req, res) => {\n  const { marketId } = req.params;\n  const user = req.user;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const body = req.body as { items?: { orderId: string; tenantId: string }[] };\n  const items = body.items ?? [];\n  const tenantIds = new Set(getTenants().filter((t) => t.marketId === marketId).map((t) => t.id));\n  for (const it of items) {\n    if (!tenantIds.has(it.tenantId)) return res.status(400).json({ error: `Order ${it.orderId} tenant not in market` });\n  }\n  const id = `job-${crypto.randomUUID?.() ?? Date.now()}`;\n  const job: DeliveryJob = {\n    id,\n    marketId,\n    status: 'NEW',\n    items,\n    createdAt: new Date().toISOString(),\n  };\n  const jobs = getDeliveryJobs();\n  jobs.push(job);\n  setDeliveryJobs(jobs);\n  res.status(201).json(job);\n});\n\napp.patch('/markets/:marketId/delivery-jobs/:jobId/assign', (req, res) => {\n  const { marketId, jobId } = req.params;\n  const user = req.user;\n  const market = getMarkets().find((m) => m.id === marketId);\n  if (!market) return res.status(404).json({ error: 'Market not found' });\n  if (user?.role === 'TENANT_ADMIN') return res.status(403).json({ error: 'Forbidden' });\n  if (user?.role === 'MARKET_ADMIN' && user.marketId !== marketId) {\n    return res.status(403).json({ error: 'Cannot assign couriers in another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  if (user?.role === 'ROOT_ADMIN' && !requireWriteWithReason(req, res)) return;\n\n  const body = req.body as { courierId: string };\n  const jobs = getDeliveryJobs();\n  const idx = jobs.findIndex((j) => j.id === jobId && j.marketId === marketId);\n  if (idx === -1) return res.status(404).json({ error: 'Delivery job not found' });\n  const courier = getCouriers().find((c) => c.id === body.courierId);\n  if (!courier) return res.status(404).json({ error: 'Courier not found' });\n  if (courierMarketId(courier) !== marketId) {\n    return res.status(403).json({ error: 'Courier belongs to another market', code: 'CROSS_MARKET_ACCESS' });\n  }\n  jobs[idx] = { ...jobs[idx], courierId: body.courierId, status: 'ASSIGNED' };\n  setDeliveryJobs(jobs);\n  res.json(jobs[idx]);\n});\n\n// --- Templates ---\napp.get('/templates', (_req, res) => {\n  res.json(getTemplates());\n});\n\n// --- Staff ---\napp.get('/staff', (req, res) => {\n  const tenantId = req.query.tenantId as string | undefined;\n  let staff = getStaff() as { tenantId?: string }[];\n  if (tenantId) staff = staff.filter((s) => s.tenantId === tenantId);\n  res.json(staff);\n});\n\napp.post('/staff', (req, res) => {\n  const user = req.body;\n  const staff = getStaff();\n  staff.push(user);\n  setStaff(staff);\n  res.status(201).json(user);\n});\n\n// Health\napp.get('/health', (_req, res) => {\n  res.json({ ok: true });\n});\n\nseedUsersIfNeeded();\nseedMarketsIfNeeded();\nseedTenantMarketIdsIfNeeded();\nseedOrdersIfNeeded();\nseedDeliveryZonesIfNeeded();\n\napp.listen(PORT, () => {\n  console.log(`Mock API server running at http://localhost:${PORT}`);\n});\n","import { readFileSync, writeFileSync, existsSync, mkdirSync, renameSync } from 'fs';\nimport { join } from 'path';\n\nconst DATA_FILE = join(process.cwd(), 'data.json');\n// packages/mock/data relative to apps/mock-api (cwd when running mock-api)\nconst ORDERS_DIR = join(process.cwd(), '..', '..', 'packages', 'mock', 'data');\nconst ORDERS_FILE = join(ORDERS_DIR, 'orders.json');\nconst ORDERS_TMP = join(ORDERS_DIR, 'orders.tmp.json');\n\nexport interface StorefrontHero {\n  title: string;\n  subtitle: string;\n  imageUrl?: string;\n  ctaText?: string;\n  ctaLink?: string;\n  ctaHref?: string;\n}\n\nexport interface StorefrontBanner {\n  id: string;\n  imageUrl: string;\n  title?: string;\n  subtitle?: string;\n  link?: string;\n  ctaText?: string;\n  ctaHref?: string;\n  enabled: boolean;\n  isActive?: boolean;\n  sortOrder: number;\n  expiresAt?: string;\n  showCountdown?: boolean;\n}\n\nexport type TenantStoreType = 'CLOTHING' | 'FOOD' | 'GENERAL';\n\nexport type MarketCategory =\n  | 'FOOD'\n  | 'CLOTHING'\n  | 'GROCERIES'\n  | 'BUTCHER'\n  | 'OFFERS'\n  | 'ELECTRONICS'\n  | 'HOME'\n  | 'GENERAL';\n\nexport interface MarketBranding {\n  logoUrl?: string;\n  primaryColor?: string;\n  hero?: StorefrontHero;\n  banners?: StorefrontBanner[];\n}\n\nexport interface Market {\n  id: string;\n  name: string;\n  slug: string;\n  branding?: MarketBranding;\n  isActive: boolean;\n  sortOrder?: number;\n}\n\n/** Delivery provider mode: TENANT = own couriers; MARKET = market couriers; PICKUP_ONLY = no delivery */\nexport type DeliveryProviderMode = 'TENANT' | 'MARKET' | 'PICKUP_ONLY';\n\n/** Tenant type for delivery eligibility: RESTAURANT needs readyAt; SHOP/SERVICE eligible immediately */\nexport type TenantType = 'RESTAURANT' | 'SHOP' | 'SERVICE';\n\nexport interface RegistryTenant {\n  id: string;\n  slug: string;\n  name: string;\n  logoUrl: string;\n  primaryColor: string;\n  secondaryColor: string;\n  fontFamily: string;\n  radiusScale: number;\n  layoutStyle: 'default' | 'compact' | 'spacious';\n  enabled: boolean;\n  createdAt: string;\n  templateId?: string;\n  hero?: StorefrontHero;\n  banners?: StorefrontBanner[];\n  whatsappPhone?: string;\n  type?: TenantStoreType;\n  marketCategory?: MarketCategory;\n  marketId?: string;\n  isListedInMarket?: boolean;\n  marketSortOrder?: number;\n  /** Delivery system: RESTAURANT | SHOP | SERVICE (default SHOP for non-FOOD) */\n  tenantType?: TenantType;\n  /** TENANT | MARKET | PICKUP_ONLY (default TENANT for delivery-enabled) */\n  deliveryProviderMode?: DeliveryProviderMode;\n  /** Option B: fallback to market courier if not assigned in time */\n  allowMarketCourierFallback?: boolean;\n  /** Default prep time in minutes for RESTAURANT orders */\n  defaultPrepTimeMin?: number;\n  /** Aggregator financial config */\n  financialConfig?: {\n    commissionType: 'PERCENTAGE' | 'FIXED';\n    commissionValue: number;\n    deliveryFeeModel: 'MARKET' | 'TENANT';\n  };\n}\n\nexport interface TenantCatalog {\n  categories: unknown[];\n  products: unknown[];\n  optionGroups: unknown[];\n  optionItems: unknown[];\n}\n\nexport interface DeliveryZoneRecord {\n  id: string;\n  tenantId: string;\n  name: string;\n  fee: number;\n  etaMinutes?: number;\n  isActive: boolean;\n  sortOrder?: number;\n}\n\nexport type UserRole = 'ROOT_ADMIN' | 'MARKET_ADMIN' | 'TENANT_ADMIN' | 'COURIER';\n\nexport interface User {\n  id: string;\n  email: string;\n  role: UserRole;\n  marketId?: string; // required for MARKET_ADMIN, COURIER\n  tenantId?: string; // required for TENANT_ADMIN\n  courierId?: string; // required for COURIER\n  /** Plain password for MVP; use hashing in production */\n  password?: string;\n}\n\n/** Courier: MARKET or TENANT scoped. Option 1: market-scoped only - every courier has marketId. */\nexport interface Courier {\n  id: string;\n  scopeType: 'MARKET' | 'TENANT';\n  scopeId: string;\n  /** Market ID for market-scoped couriers (required for MARKET scope). Option 1: every courier belongs to exactly one market. */\n  marketId?: string;\n  name: string;\n  phone?: string;\n  isActive: boolean;\n  isOnline: boolean;\n  capacity: number;\n  /** Available to take new orders (false when assigned to active delivery) */\n  isAvailable?: boolean;\n  /** Total deliveries completed (incremented when order status = DELIVERED) */\n  deliveryCount?: number;\n}\n\n/** Delivery job item (order reference) */\nexport interface DeliveryJobItem {\n  orderId: string;\n  tenantId: string;\n}\n\n/** Delivery job status */\nexport type DeliveryJobStatus = 'NEW' | 'ASSIGNED' | 'PICKING' | 'DELIVERING' | 'DONE' | 'CANCELED';\n\nexport interface DeliveryJob {\n  id: string;\n  marketId: string;\n  courierId?: string;\n  status: DeliveryJobStatus;\n  items: DeliveryJobItem[];\n  createdAt?: string;\n}\n\nexport interface AuditEvent {\n  id: string;\n  at: string;\n  userId: string;\n  role: string;\n  marketId?: string;\n  action: 'create' | 'update' | 'delete';\n  entity: string;\n  entityId: string;\n  reason?: string;\n  emergencyMode?: boolean;\n  before?: unknown;\n  after?: unknown;\n}\n\nexport interface MockData {\n  markets: Market[];\n  tenants: RegistryTenant[];\n  users: User[];\n  auditEvents: AuditEvent[];\n  catalog: Record<string, TenantCatalog>;\n  orders: unknown[];\n  campaigns: unknown[];\n  delivery: Record<string, unknown>;\n  deliveryZones: Record<string, DeliveryZoneRecord[]>;\n  couriers: Courier[];\n  deliveryJobs: DeliveryJob[];\n  templates: unknown[];\n  staff: unknown[];\n}\n\nconst DEFAULT: MockData = {\n  markets: [],\n  tenants: [],\n  users: [],\n  auditEvents: [],\n  catalog: {},\n  orders: [],\n  campaigns: [],\n  delivery: {},\n  deliveryZones: {},\n  couriers: [],\n  deliveryJobs: [],\n  templates: [],\n  staff: [],\n};\n\nconst DEFAULT_HERO: StorefrontHero = {\n  title: 'مرحباً بك',\n  subtitle: 'اكتشف أفضل المنتجات لدينا',\n  ctaText: 'تسوق الآن',\n  ctaLink: '#',\n};\n\nfunction migrateTenant(t: Record<string, unknown>): RegistryTenant {\n  const tenant = t as RegistryTenant;\n  if (!tenant.hero) {\n    tenant.hero = DEFAULT_HERO;\n  }\n  if (!tenant.banners) {\n    tenant.banners = [];\n  }\n  if (!tenant.type || !['CLOTHING', 'FOOD', 'GENERAL'].includes(tenant.type)) {\n    tenant.type = 'GENERAL';\n  }\n  if (!tenant.marketCategory) {\n    tenant.marketCategory = 'GENERAL';\n  }\n  if (tenant.isListedInMarket === undefined) {\n    tenant.isListedInMarket = true;\n  }\n  if (!tenant.tenantType) {\n    tenant.tenantType = tenant.type === 'FOOD' ? 'RESTAURANT' : 'SHOP';\n  }\n  if (!tenant.deliveryProviderMode) {\n    tenant.deliveryProviderMode = 'TENANT';\n  }\n  if (tenant.allowMarketCourierFallback === undefined) {\n    tenant.allowMarketCourierFallback = true;\n  }\n  if (tenant.defaultPrepTimeMin === undefined && tenant.tenantType === 'RESTAURANT') {\n    tenant.defaultPrepTimeMin = 30;\n  }\n  if (!tenant.financialConfig) {\n    (tenant as RegistryTenant).financialConfig = {\n      commissionType: 'PERCENTAGE',\n      commissionValue: 10,\n      deliveryFeeModel: 'TENANT',\n    };\n  }\n  return tenant;\n}\n\nfunction migrateCategory(c: Record<string, unknown>): Record<string, unknown> {\n  if (c.parentId === undefined) c.parentId = null;\n  if (c.isVisible === undefined) c.isVisible = true;\n  return c;\n}\n\nfunction migrateCourier(c: Record<string, unknown>): Courier {\n  const courier = c as Courier;\n  if (courier.scopeType === 'MARKET' && !courier.marketId) {\n    courier.marketId = courier.scopeId;\n  }\n  return courier;\n}\n\nfunction load(): MockData {\n  try {\n    if (existsSync(DATA_FILE)) {\n      const raw = readFileSync(DATA_FILE, 'utf-8');\n      const parsed = JSON.parse(raw) as Partial<MockData>;\n      const markets = parsed.markets ?? [];\n      const tenants = (parsed.tenants ?? []).map((t) => migrateTenant(t as Record<string, unknown>));\n      const catalog: Record<string, TenantCatalog> = {};\n      for (const [tid, cat] of Object.entries(parsed.catalog ?? {})) {\n        const c = cat as TenantCatalog;\n        catalog[tid] = {\n          categories: (c.categories ?? []).map((x) => migrateCategory(x as Record<string, unknown>)),\n          products: c.products ?? [],\n          optionGroups: c.optionGroups ?? [],\n          optionItems: c.optionItems ?? [],\n        };\n      }\n      const users = (parsed.users ?? []) as User[];\n      const auditEvents = (parsed.auditEvents ?? []) as AuditEvent[];\n      return {\n        markets,\n        tenants,\n        users,\n        auditEvents,\n        catalog,\n        orders: [],\n        campaigns: parsed.campaigns ?? [],\n        delivery: parsed.delivery ?? {},\n        deliveryZones: parsed.deliveryZones ?? {},\n        couriers: (parsed.couriers ?? []).map((c) => migrateCourier(c as Record<string, unknown>)),\n        deliveryJobs: parsed.deliveryJobs ?? [],\n        templates: parsed.templates ?? [],\n        staff: parsed.staff ?? [],\n      };\n    }\n  } catch {\n    /* ignore */\n  }\n  return { ...DEFAULT, users: [], auditEvents: [] };\n}\n\nfunction save(data: MockData): void {\n  writeFileSync(DATA_FILE, JSON.stringify(data, null, 2), 'utf-8');\n}\n\n// --- Orders: separate persistence in packages/mock/data/orders.json ---\nfunction loadOrders(): unknown[] {\n  try {\n    if (!existsSync(ORDERS_FILE)) return [];\n    const raw = readFileSync(ORDERS_FILE, 'utf-8');\n    const parsed = JSON.parse(raw);\n    return Array.isArray(parsed) ? parsed : [];\n  } catch {\n    return [];\n  }\n}\n\nfunction saveOrders(orders: unknown[]): void {\n  try {\n    if (!existsSync(ORDERS_DIR)) mkdirSync(ORDERS_DIR, { recursive: true });\n    writeFileSync(ORDERS_TMP, JSON.stringify(orders, null, 2), 'utf-8');\n    renameSync(ORDERS_TMP, ORDERS_FILE);\n  } catch (err) {\n    console.error('Failed to persist orders:', err);\n  }\n}\n\nlet cache: MockData | null = null;\n\nexport function getData(): MockData {\n  if (!cache) cache = load();\n  return cache;\n}\n\nexport function persist(): void {\n  if (cache) save(cache);\n}\n\nexport function getMarkets(): Market[] {\n  return getData().markets;\n}\n\nexport function setMarkets(markets: Market[]): void {\n  getData().markets = markets;\n  persist();\n}\n\nexport function getTenants(): RegistryTenant[] {\n  return getData().tenants;\n}\n\nexport function setTenants(tenants: RegistryTenant[]): void {\n  getData().tenants = tenants;\n  persist();\n}\n\nexport function getUsers(): User[] {\n  return getData().users;\n}\n\nexport function setUsers(users: User[]): void {\n  getData().users = users;\n  persist();\n}\n\nexport function getAuditEvents(): AuditEvent[] {\n  return getData().auditEvents;\n}\n\nexport function appendAuditEvent(event: Omit<AuditEvent, 'id' | 'at'>): void {\n  const data = getData();\n  const ev: AuditEvent = {\n    ...event,\n    id: `audit-${crypto.randomUUID?.() ?? Date.now()}`,\n    at: new Date().toISOString(),\n  };\n  data.auditEvents = [...(data.auditEvents ?? []), ev];\n  persist();\n}\n\nexport function getCatalog(tenantId: string): TenantCatalog {\n  const cat = getData().catalog[tenantId];\n  if (!cat) {\n    return { categories: [], products: [], optionGroups: [], optionItems: [] };\n  }\n  const categories = (cat.categories ?? []).map((c) => {\n    const x = c as Record<string, unknown>;\n    if (x.parentId === undefined) x.parentId = null;\n    if (x.isVisible === undefined) x.isVisible = true;\n    return x;\n  });\n  return {\n    categories,\n    products: cat.products ?? [],\n    optionGroups: cat.optionGroups ?? [],\n    optionItems: cat.optionItems ?? [],\n  };\n}\n\nexport function setCatalog(tenantId: string, catalog: TenantCatalog): void {\n  getData().catalog[tenantId] = {\n    categories: catalog.categories ?? [],\n    products: catalog.products ?? [],\n    optionGroups: catalog.optionGroups ?? [],\n    optionItems: catalog.optionItems ?? [],\n  };\n  persist();\n}\n\nlet ordersCache: unknown[] | null = null;\n\nexport function getOrders(): unknown[] {\n  if (ordersCache === null) ordersCache = loadOrders();\n  return ordersCache;\n}\n\nexport function setOrders(orders: unknown[]): void {\n  ordersCache = orders;\n  saveOrders(orders);\n}\n\nexport function getCampaigns(): unknown[] {\n  return getData().campaigns;\n}\n\nexport function setCampaigns(campaigns: unknown[]): void {\n  getData().campaigns = campaigns;\n  persist();\n}\n\nexport function getDelivery(): Record<string, unknown> {\n  return getData().delivery;\n}\n\nexport function setDelivery(delivery: Record<string, unknown>): void {\n  getData().delivery = delivery;\n  persist();\n}\n\nexport function getDeliveryZones(tenantId: string): DeliveryZoneRecord[] {\n  return getData().deliveryZones[tenantId] ?? [];\n}\n\nexport function setDeliveryZones(tenantId: string, zones: DeliveryZoneRecord[]): void {\n  getData().deliveryZones[tenantId] = zones;\n  persist();\n}\n\nexport function getCouriers(): Courier[] {\n  return getData().couriers ?? [];\n}\n\nexport function setCouriers(couriers: Courier[]): void {\n  getData().couriers = couriers;\n  persist();\n}\n\nexport function getDeliveryJobs(): DeliveryJob[] {\n  return getData().deliveryJobs ?? [];\n}\n\nexport function setDeliveryJobs(jobs: DeliveryJob[]): void {\n  getData().deliveryJobs = jobs;\n  persist();\n}\n\nexport function getTemplates(): unknown[] {\n  return getData().templates;\n}\n\nexport function setTemplates(templates: unknown[]): void {\n  getData().templates = templates;\n  persist();\n}\n\nexport function getStaff(): unknown[] {\n  return getData().staff;\n}\n\nexport function setStaff(staff: unknown[]): void {\n  getData().staff = staff;\n  persist();\n}\n","/**\r\n * Delivery System Rules Engine\r\n * NEAR_READY_WINDOW_MINUTES = 10\r\n * BATCH_WINDOW_MINUTES = 7\r\n * Fallback: SHOP/SERVICE 5 min; RESTAURANT READY 5 min; RESTAURANT near-ready 7 min\r\n */\r\n\r\nimport type { RegistryTenant } from './store.js';\r\nimport { getTenants, getOrders, setOrders, getDeliveryJobs } from './store.js';\r\n\r\nexport const NEAR_READY_WINDOW_MINUTES = 10;\r\nexport const BATCH_WINDOW_MINUTES = 7;\r\nexport const FALLBACK_SHOP_SERVICE_MINUTES = 5;\r\nexport const FALLBACK_RESTAURANT_READY_MINUTES = 5;\r\nexport const FALLBACK_RESTAURANT_NEAR_READY_MINUTES = 7;\r\n\r\nexport type OrderStatus = 'NEW' | 'PREPARING' | 'READY' | 'OUT_FOR_DELIVERY' | 'DELIVERED' | 'CANCELED';\r\nexport type DeliveryAssignmentMode = 'TENANT' | 'MARKET';\r\n\r\nexport interface OrderRecord {\r\n  id?: string;\r\n  tenantId?: string;\r\n  status?: string;\r\n  prepTimeMin?: number;\r\n  readyAt?: string;\r\n  deliveryAssignmentMode?: DeliveryAssignmentMode;\r\n  fallbackTriggeredAt?: string;\r\n  createdAt?: string;\r\n  fulfillmentType?: string;\r\n  [key: string]: unknown;\r\n}\r\n\r\nfunction getTenant(tenantId: string): RegistryTenant | undefined {\r\n  return getTenants().find((t) => t.id === tenantId);\r\n}\r\n\r\n/** Check if order is eligible for MARKET dispatch (READY or near-ready for RESTAURANT; immediately for SHOP/SERVICE) */\r\nexport function isOrderEligibleForMarketDispatch(order: OrderRecord): boolean {\r\n  const tenant = order.tenantId ? getTenant(order.tenantId) : undefined;\r\n  const tenantType = tenant?.tenantType ?? 'SHOP';\r\n  const mode = order.deliveryAssignmentMode ?? 'TENANT';\r\n\r\n  if (mode !== 'MARKET') return false;\r\n  if (order.fulfillmentType === 'PICKUP') return false;\r\n  if (['OUT_FOR_DELIVERY', 'DELIVERED', 'CANCELED'].includes(order.status ?? '')) return false;\r\n\r\n  if (tenantType === 'RESTAURANT') {\r\n    const status = order.status ?? 'PREPARING';\r\n    if (status === 'READY') return true;\r\n    const readyAt = order.readyAt;\r\n    if (!readyAt) return false;\r\n    const now = Date.now();\r\n    const readyMs = new Date(readyAt).getTime();\r\n    const diffMin = (readyMs - now) / (60 * 1000);\r\n    return diffMin <= NEAR_READY_WINDOW_MINUTES;\r\n  }\r\n\r\n  // SHOP or SERVICE: eligible if PREPARING or READY (no readyAt needed)\r\n  return ['PREPARING', 'READY', 'NEW'].includes(order.status ?? '');\r\n}\r\n\r\n/** Evaluate fallback: TENANT -> MARKET when allowMarketCourierFallback and conditions met */\r\nexport function evaluateFallback(marketId: string): void {\r\n  const tenants = getTenants().filter((t) => t.marketId === marketId);\r\n  const tenantIds = new Set(tenants.map((t) => t.id));\r\n  const orders = getOrders() as OrderRecord[];\r\n  const now = Date.now();\r\n  let changed = false;\r\n  const updated = orders.map((o) => {\r\n    if (!o.tenantId || !tenantIds.has(o.tenantId)) return o;\r\n    if (o.deliveryAssignmentMode === 'MARKET' || o.fallbackTriggeredAt) return o;\r\n    if (o.fulfillmentType === 'PICKUP') return o;\r\n    const tenant = getTenant(o.tenantId);\r\n    if (!tenant?.allowMarketCourierFallback) return o;\r\n\r\n    const createdAt = o.createdAt ? new Date(o.createdAt).getTime() : now;\r\n    const elapsedMin = (now - createdAt) / (60 * 1000);\r\n    const tenantType = tenant.tenantType ?? 'SHOP';\r\n\r\n    if (tenantType === 'RESTAURANT') {\r\n      const status = o.status ?? 'PREPARING';\r\n      const readyAt = o.readyAt ? new Date(o.readyAt).getTime() : 0;\r\n      const isReady = status === 'READY';\r\n      const isNearReady = !isReady && readyAt && (readyAt - now) / (60 * 1000) <= NEAR_READY_WINDOW_MINUTES;\r\n\r\n      if (isReady && elapsedMin >= FALLBACK_RESTAURANT_READY_MINUTES) {\r\n        changed = true;\r\n        return { ...o, deliveryAssignmentMode: 'MARKET' as const, fallbackTriggeredAt: new Date().toISOString() };\r\n      }\r\n      if (isNearReady && elapsedMin >= FALLBACK_RESTAURANT_NEAR_READY_MINUTES) {\r\n        changed = true;\r\n        return { ...o, deliveryAssignmentMode: 'MARKET' as const, fallbackTriggeredAt: new Date().toISOString() };\r\n      }\r\n    } else {\r\n      // SHOP or SERVICE\r\n      if (elapsedMin >= FALLBACK_SHOP_SERVICE_MINUTES) {\r\n        changed = true;\r\n        return { ...o, deliveryAssignmentMode: 'MARKET' as const, fallbackTriggeredAt: new Date().toISOString() };\r\n      }\r\n    }\r\n    return o;\r\n  });\r\n\r\n  if (changed) setOrders(updated);\r\n}\r\n\r\n/** Get queue of orders eligible for MARKET dispatch (after fallback eval) */\r\nexport function getDispatchQueue(marketId: string): OrderRecord[] {\r\n  evaluateFallback(marketId);\r\n  const tenants = getTenants().filter((t) => t.marketId === marketId);\r\n  const tenantIds = new Set(tenants.map((t) => t.id));\r\n  const orders = getOrders() as OrderRecord[];\r\n  const jobs = getDeliveryJobs();\r\n  const activeJobOrderIds = new Set(\r\n    jobs\r\n      .filter((j) => !['CANCELED', 'DONE'].includes(j.status))\r\n      .flatMap((j) => j.items.map((i) => i.orderId))\r\n  );\r\n\r\n  return orders\r\n    .filter((o) => o.tenantId && tenantIds.has(o.tenantId))\r\n    .filter((o) => isOrderEligibleForMarketDispatch(o))\r\n    .filter((o) => !o.courierId)\r\n    .filter((o) => !activeJobOrderIds.has(o.id ?? ''))\r\n    .sort((a, b) => {\r\n      const aReady = a.readyAt ? new Date(a.readyAt).getTime() : 0;\r\n      const bReady = b.readyAt ? new Date(b.readyAt).getTime() : 0;\r\n      if (aReady && bReady) return aReady - bReady;\r\n      return (a.createdAt ?? '').localeCompare(b.createdAt ?? '');\r\n    });\r\n}\r\n\r\n/** Check if two orders can be batched (same tenant for RESTAURANT; readyAt within BATCH_WINDOW) */\r\nexport function canBatchOrders(orderA: OrderRecord, orderB: OrderRecord): boolean {\r\n  const tenantA = orderA.tenantId ? getTenant(orderA.tenantId) : undefined;\r\n  const tenantB = orderB.tenantId ? getTenant(orderB.tenantId) : undefined;\r\n  const typeA = tenantA?.tenantType ?? 'SHOP';\r\n  const typeB = tenantB?.tenantType ?? 'SHOP';\r\n\r\n  if (typeA === 'RESTAURANT' || typeB === 'RESTAURANT') {\r\n    if (orderA.tenantId !== orderB.tenantId) return false;\r\n    const aReady = orderA.readyAt ? new Date(orderA.readyAt).getTime() : 0;\r\n    const bReady = orderB.readyAt ? new Date(orderB.readyAt).getTime() : 0;\r\n    if (!aReady || !bReady) return orderA.status === 'READY' && orderB.status === 'READY';\r\n    return Math.abs(aReady - bReady) / (60 * 1000) <= BATCH_WINDOW_MINUTES;\r\n  }\r\n  return true;\r\n}\r\n"],"mappings":"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","names":["join","existsSync","mkdirSync","join","existsSync","mkdirSync","DEFAULT_HERO","tenant"]}